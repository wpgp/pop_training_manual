<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>9 Model Fit Checks and Cross-Validation | WorldPop Population Modelling Training Manual, Vol. I</title>
  <meta name="description" content="An open book of WorldPop methods to produce gridded population estimates." />
  <meta name="generator" content="bookdown 0.43 and GitBook 2.6.7" />

  <meta property="og:title" content="9 Model Fit Checks and Cross-Validation | WorldPop Population Modelling Training Manual, Vol. I" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="An open book of WorldPop methods to produce gridded population estimates." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="9 Model Fit Checks and Cross-Validation | WorldPop Population Modelling Training Manual, Vol. I" />
  
  <meta name="twitter:description" content="An open book of WorldPop methods to produce gridded population estimates." />
  

<meta name="author" content="WorldPop, University of Southampton" />


<meta name="date" content="2025-07-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="bayesian-hierarchical-population-modelling-in-r.html"/>
<link rel="next" href="population-prediction-and-uncertainty-quantification.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<link href="libs/health_facilities - type-CSS-0.0.1/health_facilities - type_home-button.css" rel="stylesheet" />
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<link href="libs/states-CSS-0.0.1/states_home-button.css" rel="stylesheet" />
<link href="libs/states_utm-CSS-0.0.1/states_utm_home-button.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#preface"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#book-contents"><i class="fa fa-check"></i>Book Contents</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html"><i class="fa fa-check"></i><b>1</b> Basics of R Programming</a>
<ul>
<li class="chapter" data-level="1.1" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#overview-of-r"><i class="fa fa-check"></i><b>1.1</b> Overview of R</a>
<ul>
<li class="chapter" data-level="" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#getting-started-with-r"><i class="fa fa-check"></i>Getting started with R</a>
<ul>
<li class="chapter" data-level="" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#downloading-r-and-rstudio"><i class="fa fa-check"></i>Downloading R and RStudio</a></li>
<li class="chapter" data-level="" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#features-of-the-r-gui-environment"><i class="fa fa-check"></i>Features of the R GUI environment</a></li>
<li class="chapter" data-level="" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#features-of-the-rstudio-environment"><i class="fa fa-check"></i>Features of the RStudio environment</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#creating-opening-and-saving-r-scripts"><i class="fa fa-check"></i>Creating, opening and saving R scripts</a></li>
<li class="chapter" data-level="1.1.1" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#getting-and-setting-the-working-directory"><i class="fa fa-check"></i><b>1.1.1</b> Getting and setting the working directory</a></li>
<li class="chapter" data-level="1.1.2" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#creating-opening-and-saving-r-projects"><i class="fa fa-check"></i><b>1.1.2</b> Creating, opening and saving R projects</a></li>
<li class="chapter" data-level="1.1.3" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#getting-help-in-r"><i class="fa fa-check"></i><b>1.1.3</b> Getting help in R</a></li>
<li class="chapter" data-level="1.1.4" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#r-coding-best-practices"><i class="fa fa-check"></i><b>1.1.4</b> R coding best practices</a>
<ul>
<li class="chapter" data-level="1.1.4.1" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#commenting"><i class="fa fa-check"></i><b>1.1.4.1</b> Commenting</a></li>
<li class="chapter" data-level="1.1.4.2" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#naming-conventions"><i class="fa fa-check"></i><b>1.1.4.2</b> Naming conventions</a></li>
<li class="chapter" data-level="1.1.4.3" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#spacing"><i class="fa fa-check"></i><b>1.1.4.3</b> Spacing</a></li>
<li class="chapter" data-level="1.1.4.4" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#punctuation"><i class="fa fa-check"></i><b>1.1.4.4</b> Punctuation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#data-types-and-key-components"><i class="fa fa-check"></i><b>1.2</b> Data types and key components</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#basic-operations-in-r"><i class="fa fa-check"></i><b>1.2.1</b> Basic operations in R</a>
<ul>
<li class="chapter" data-level="1.2.1.1" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#arithmetic-operators"><i class="fa fa-check"></i><b>1.2.1.1</b> Arithmetic operators</a></li>
<li class="chapter" data-level="1.2.1.2" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#logical-operators"><i class="fa fa-check"></i><b>1.2.1.2</b> Logical operators</a></li>
<li class="chapter" data-level="1.2.1.3" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#other-operators"><i class="fa fa-check"></i><b>1.2.1.3</b> Other operators</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#key-functions-in-r"><i class="fa fa-check"></i><b>1.3</b> Key functions in R</a></li>
<li class="chapter" data-level="1.4" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#data-structures"><i class="fa fa-check"></i><b>1.4</b> Data structures</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#vectors"><i class="fa fa-check"></i><b>1.4.1</b> Vectors</a></li>
<li class="chapter" data-level="1.4.2" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#matrices"><i class="fa fa-check"></i><b>1.4.2</b> Matrices</a></li>
<li class="chapter" data-level="1.4.3" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#arrays"><i class="fa fa-check"></i><b>1.4.3</b> Arrays</a></li>
<li class="chapter" data-level="1.4.4" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#data-frames"><i class="fa fa-check"></i><b>1.4.4</b> Data frames</a></li>
<li class="chapter" data-level="1.4.5" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#list"><i class="fa fa-check"></i><b>1.4.5</b> List</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#end-of-module-exercises"><i class="fa fa-check"></i><b>1.5</b> End of module exercises</a></li>
<li class="chapter" data-level="1.6" data-path="basics-of-r-programming.html"><a href="basics-of-r-programming.html#useful-resources"><i class="fa fa-check"></i><b>1.6</b> Useful resources</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html"><i class="fa fa-check"></i><b>2</b> Working with Data Frames</a>
<ul>
<li class="chapter" data-level="2.1" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#importing-and-exporting-data-in-and-from-r"><i class="fa fa-check"></i><b>2.1</b> Importing and exporting data in and from R</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#installing-and-loading-packages"><i class="fa fa-check"></i><b>2.1.1</b> Installing and loading packages</a></li>
<li class="chapter" data-level="2.1.2" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#reading-data-into-the-r-environment"><i class="fa fa-check"></i><b>2.1.2</b> Reading data into the R environment</a></li>
<li class="chapter" data-level="2.1.3" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#creating-work-paths"><i class="fa fa-check"></i><b>2.1.3</b> Creating work paths</a></li>
<li class="chapter" data-level="2.1.4" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#exploring-data-attributes"><i class="fa fa-check"></i><b>2.1.4</b> Exploring data attributes</a></li>
<li class="chapter" data-level="2.1.5" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#viewing-data"><i class="fa fa-check"></i><b>2.1.5</b> Viewing data</a></li>
<li class="chapter" data-level="2.1.6" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#extracting-data"><i class="fa fa-check"></i><b>2.1.6</b> Extracting data</a></li>
<li class="chapter" data-level="2.1.7" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#attaching-data"><i class="fa fa-check"></i><b>2.1.7</b> Attaching data</a></li>
<li class="chapter" data-level="2.1.8" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#writing-data-to-external-repositories"><i class="fa fa-check"></i><b>2.1.8</b> Writing data to external repositories</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#basic-data-wrangling-methods-for-data-preparation-and-handling-in-r"><i class="fa fa-check"></i><b>2.2</b> Basic data wrangling methods for data preparation and handling in R</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#dealing-with-na-not-available-values"><i class="fa fa-check"></i><b>2.2.1</b> Dealing with NA (‘Not Available’) values</a></li>
<li class="chapter" data-level="2.2.2" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#key-data-wrangling-methods"><i class="fa fa-check"></i><b>2.2.2</b> Key data wrangling methods</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#data-visualisation"><i class="fa fa-check"></i><b>2.3</b> Data visualisation</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#bar-plots"><i class="fa fa-check"></i><b>2.3.1</b> Bar plots</a></li>
<li class="chapter" data-level="2.3.2" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#box-plots"><i class="fa fa-check"></i><b>2.3.2</b> Box plots</a></li>
<li class="chapter" data-level="2.3.3" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#histograms"><i class="fa fa-check"></i><b>2.3.3</b> Histograms</a></li>
<li class="chapter" data-level="2.3.4" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#density-plots"><i class="fa fa-check"></i><b>2.3.4</b> Density plots</a></li>
<li class="chapter" data-level="2.3.5" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#scatter-plots"><i class="fa fa-check"></i><b>2.3.5</b> Scatter plots</a></li>
<li class="chapter" data-level="2.3.6" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#violin-plots"><i class="fa fa-check"></i><b>2.3.6</b> Violin plots</a></li>
<li class="chapter" data-level="2.3.7" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#line-graphs"><i class="fa fa-check"></i><b>2.3.7</b> Line graphs</a></li>
<li class="chapter" data-level="2.3.8" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#population-pyramids"><i class="fa fa-check"></i><b>2.3.8</b> Population pyramids</a></li>
<li class="chapter" data-level="2.3.9" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#lollipop-plots"><i class="fa fa-check"></i><b>2.3.9</b> Lollipop plots</a></li>
<li class="chapter" data-level="2.3.10" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#plots-with-an-image-background"><i class="fa fa-check"></i><b>2.3.10</b> Plots with an image background</a></li>
<li class="chapter" data-level="2.3.11" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#viewing-and-saving-plots"><i class="fa fa-check"></i><b>2.3.11</b> Viewing and saving plots</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#end-of-module-exercises-1"><i class="fa fa-check"></i><b>2.4</b> End of module exercises</a></li>
<li class="chapter" data-level="2.5" data-path="working-with-data-frames.html"><a href="working-with-data-frames.html#useful-resources-1"><i class="fa fa-check"></i><b>2.5</b> Useful resources</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html"><i class="fa fa-check"></i><b>3</b> Working with Spatial Data in R</a>
<ul>
<li class="chapter" data-level="3.1" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#spatial-data-overview-and-types"><i class="fa fa-check"></i><b>3.1</b> Spatial data: Overview and types</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#points-data"><i class="fa fa-check"></i><b>3.1.1</b> Points data</a></li>
<li class="chapter" data-level="3.1.2" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#areal-data"><i class="fa fa-check"></i><b>3.1.2</b> Areal data</a></li>
<li class="chapter" data-level="3.1.3" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#vector-data"><i class="fa fa-check"></i><b>3.1.3</b> Vector data</a>
<ul>
<li class="chapter" data-level="3.1.3.1" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#points"><i class="fa fa-check"></i><b>3.1.3.1</b> Points</a></li>
<li class="chapter" data-level="3.1.3.2" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#polylines"><i class="fa fa-check"></i><b>3.1.3.2</b> Polylines</a></li>
<li class="chapter" data-level="3.1.3.3" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#polygons"><i class="fa fa-check"></i><b>3.1.3.3</b> Polygons</a></li>
</ul></li>
<li class="chapter" data-level="3.1.4" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#raster-data"><i class="fa fa-check"></i><b>3.1.4</b> Raster data</a></li>
<li class="chapter" data-level="3.1.5" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#sources-of-spatial-data"><i class="fa fa-check"></i><b>3.1.5</b> Sources of spatial data</a></li>
<li class="chapter" data-level="3.1.6" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#geospatial-covariates"><i class="fa fa-check"></i><b>3.1.6</b> Geospatial covariates</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#basic-gis-concepts"><i class="fa fa-check"></i><b>3.2</b> Basic GIS concepts</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#geoprocessing"><i class="fa fa-check"></i><b>3.2.1</b> Geoprocessing</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#using-gis-in-r"><i class="fa fa-check"></i><b>3.3</b> Using GIS in R</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#importing-spatial-data-in-r"><i class="fa fa-check"></i><b>3.3.1</b> Importing spatial data in R</a></li>
<li class="chapter" data-level="3.3.2" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#handling-spatial-data-in-r"><i class="fa fa-check"></i><b>3.3.2</b> Handling spatial data in R</a>
<ul>
<li class="chapter" data-level="3.3.2.1" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#converting-between-vectors-and-rasters-in-r"><i class="fa fa-check"></i><b>3.3.2.1</b> Converting between vectors and rasters in R</a></li>
<li class="chapter" data-level="3.3.2.2" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#checking-the-resolution-and-number-of-cells"><i class="fa fa-check"></i><b>3.3.2.2</b> Checking the resolution and number of cells</a></li>
<li class="chapter" data-level="3.3.2.3" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#exporting-spatial-data-in-various-formats"><i class="fa fa-check"></i><b>3.3.2.3</b> Exporting spatial data in various formats</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#visualisation-of-spatial-data"><i class="fa fa-check"></i><b>3.4</b> Visualisation of spatial data</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#static-maps"><i class="fa fa-check"></i><b>3.4.1</b> Static maps</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#interactive-maps"><i class="fa fa-check"></i><b>3.5</b> Interactive maps</a>
<ul>
<li class="chapter" data-level="" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#visualisation-with-tmap-1"><i class="fa fa-check"></i>Visualisation with <code>tmap</code></a></li>
<li class="chapter" data-level="" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#visualisation-with-leaflet"><i class="fa fa-check"></i>Visualisation with <code>leaflet</code></a></li>
<li class="chapter" data-level="" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#visualisation-with-mapview"><i class="fa fa-check"></i>Visualisation with <code>mapview</code></a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#basic-geoprocessing"><i class="fa fa-check"></i><b>3.6</b> Basic geoprocessing</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#coordinate-reference-systems-crs"><i class="fa fa-check"></i><b>3.6.1</b> Coordinate reference systems (CRS)</a></li>
<li class="chapter" data-level="3.6.2" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#converting-between-latlong-and-the-universal-transverse-mercator-utm-coordinate-system"><i class="fa fa-check"></i><b>3.6.2</b> Converting between Lat/Long and the Universal Transverse Mercator (UTM) coordinate system</a></li>
<li class="chapter" data-level="3.6.3" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#subsetting-clipping-and-masking"><i class="fa fa-check"></i><b>3.6.3</b> Subsetting, clipping and masking</a></li>
<li class="chapter" data-level="3.6.4" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#buffer-analysis"><i class="fa fa-check"></i><b>3.6.4</b> Buffer analysis</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#end-of-module-exercises-2"><i class="fa fa-check"></i><b>3.7</b> End of module exercises</a></li>
<li class="chapter" data-level="3.8" data-path="working-with-spatial-data-in-r.html"><a href="working-with-spatial-data-in-r.html#useful-resources-2"><i class="fa fa-check"></i><b>3.8</b> Useful resources</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html"><i class="fa fa-check"></i><b>4</b> Introduction to Statistical Modelling with Implementation in R</a>
<ul>
<li class="chapter" data-level="4.1" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#concept-of-statistical-modelling"><i class="fa fa-check"></i><b>4.1</b> Concept of statistical modelling</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#overview-of-statistical-modelling"><i class="fa fa-check"></i><b>4.1.1</b> Overview of statistical modelling</a></li>
<li class="chapter" data-level="4.1.2" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#correlation"><i class="fa fa-check"></i><b>4.1.2</b> Correlation</a></li>
<li class="chapter" data-level="4.1.3" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#scaled-covariates"><i class="fa fa-check"></i><b>4.1.3</b> Scaled covariates</a></li>
<li class="chapter" data-level="4.1.4" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#uncertainty"><i class="fa fa-check"></i><b>4.1.4</b> Uncertainty</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#simple-regression"><i class="fa fa-check"></i><b>4.2</b> Simple regression</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#linear-regression"><i class="fa fa-check"></i><b>4.2.1</b> Linear regression</a></li>
<li class="chapter" data-level="4.2.2" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#polynomial-regression"><i class="fa fa-check"></i><b>4.2.2</b> Polynomial regression</a></li>
<li class="chapter" data-level="4.2.3" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#non-linear-regression"><i class="fa fa-check"></i><b>4.2.3</b> Non-linear regression</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#multiple-regression"><i class="fa fa-check"></i><b>4.3</b> Multiple regression</a></li>
<li class="chapter" data-level="4.4" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#generalised-linear-regression"><i class="fa fa-check"></i><b>4.4</b> Generalised linear regression</a></li>
<li class="chapter" data-level="4.5" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#model-predictions"><i class="fa fa-check"></i><b>4.5</b> Model predictions</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#predictions-with-the-formula-and-coefficients"><i class="fa fa-check"></i><b>4.5.1</b> Predictions with the formula and coefficients</a></li>
<li class="chapter" data-level="4.5.2" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#predictions-with-functions"><i class="fa fa-check"></i><b>4.5.2</b> Predictions with functions</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#model-selection"><i class="fa fa-check"></i><b>4.6</b> Model selection</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#accuracy-and-precision"><i class="fa fa-check"></i><b>4.6.1</b> Accuracy and precision</a></li>
<li class="chapter" data-level="4.6.2" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#akaike-information-criterion"><i class="fa fa-check"></i><b>4.6.2</b> Akaike information criterion</a></li>
<li class="chapter" data-level="4.6.3" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#bayesian-information-criterion"><i class="fa fa-check"></i><b>4.6.3</b> Bayesian information criterion</a></li>
<li class="chapter" data-level="4.6.4" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#r-squared-statistic"><i class="fa fa-check"></i><b>4.6.4</b> R-squared statistic</a></li>
<li class="chapter" data-level="4.6.5" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#analysis-of-variance"><i class="fa fa-check"></i><b>4.6.5</b> Analysis of variance</a></li>
<li class="chapter" data-level="4.6.6" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#likelihood-ratio-testing"><i class="fa fa-check"></i><b>4.6.6</b> Likelihood ratio testing</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#stepwise-regression"><i class="fa fa-check"></i><b>4.7</b> Stepwise regression</a>
<ul>
<li class="chapter" data-level="4.7.1" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#forward-stepwise-regression"><i class="fa fa-check"></i><b>4.7.1</b> Forward stepwise regression</a></li>
<li class="chapter" data-level="4.7.2" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#backward-stepwise-regression"><i class="fa fa-check"></i><b>4.7.2</b> Backward stepwise regression</a></li>
<li class="chapter" data-level="4.7.3" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#both-ways-stepwise-regression"><i class="fa fa-check"></i><b>4.7.3</b> Both ways stepwise regression</a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#cross-validation"><i class="fa fa-check"></i><b>4.8</b> Cross-validation</a>
<ul>
<li class="chapter" data-level="4.8.1" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#k-fold-cross-validation"><i class="fa fa-check"></i><b>4.8.1</b> <em>k</em>-fold cross-validation</a></li>
<li class="chapter" data-level="4.8.2" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#leave-one-out-cross-validation"><i class="fa fa-check"></i><b>4.8.2</b> Leave-one-out cross-validation</a></li>
</ul></li>
<li class="chapter" data-level="4.9" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#hierarchical-regression"><i class="fa fa-check"></i><b>4.9</b> Hierarchical regression</a>
<ul>
<li class="chapter" data-level="4.9.1" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#data-structure"><i class="fa fa-check"></i><b>4.9.1</b> Data structure</a></li>
<li class="chapter" data-level="4.9.2" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#variance-partition-coefficient"><i class="fa fa-check"></i><b>4.9.2</b> Variance partition coefficient</a></li>
<li class="chapter" data-level="4.9.3" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#random-intercepts-modelling"><i class="fa fa-check"></i><b>4.9.3</b> Random intercepts modelling</a></li>
<li class="chapter" data-level="4.9.4" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#random-intercepts-mixed-effects-modelling"><i class="fa fa-check"></i><b>4.9.4</b> Random intercepts mixed-effects modelling</a></li>
<li class="chapter" data-level="4.9.5" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#random-slope-mixed-effects-modelling"><i class="fa fa-check"></i><b>4.9.5</b> Random slope mixed-effects modelling</a></li>
<li class="chapter" data-level="4.9.6" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#adding-an-extra-level"><i class="fa fa-check"></i><b>4.9.6</b> Adding an extra level</a></li>
</ul></li>
<li class="chapter" data-level="4.10" data-path="introduction-to-statistical-modelling-with-implementation-in-r.html"><a href="introduction-to-statistical-modelling-with-implementation-in-r.html#useful-resources-3"><i class="fa fa-check"></i><b>4.10</b> Useful resources</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="probability-theory-and-applications.html"><a href="probability-theory-and-applications.html"><i class="fa fa-check"></i><b>5</b> Probability Theory and Applications</a>
<ul>
<li class="chapter" data-level="5.1" data-path="probability-theory-and-applications.html"><a href="probability-theory-and-applications.html#introduction-to-probability"><i class="fa fa-check"></i><b>5.1</b> Introduction to probability</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="probability-theory-and-applications.html"><a href="probability-theory-and-applications.html#theoretical-and-experimental-probability"><i class="fa fa-check"></i><b>5.1.1</b> Theoretical and experimental probability</a></li>
<li class="chapter" data-level="5.1.2" data-path="probability-theory-and-applications.html"><a href="probability-theory-and-applications.html#keywords"><i class="fa fa-check"></i><b>5.1.2</b> Keywords</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="probability-theory-and-applications.html"><a href="probability-theory-and-applications.html#axioms-of-probability"><i class="fa fa-check"></i><b>5.2</b> Axioms of probability</a></li>
<li class="chapter" data-level="5.3" data-path="probability-theory-and-applications.html"><a href="probability-theory-and-applications.html#joint-probability"><i class="fa fa-check"></i><b>5.3</b> Joint probability</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="probability-theory-and-applications.html"><a href="probability-theory-and-applications.html#joint-probability-table"><i class="fa fa-check"></i><b>5.3.1</b> Joint probability table</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="probability-theory-and-applications.html"><a href="probability-theory-and-applications.html#conditional-probability"><i class="fa fa-check"></i><b>5.4</b> Conditional probability</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="probability-theory-and-applications.html"><a href="probability-theory-and-applications.html#multiplication-rule-of-conditional-probability"><i class="fa fa-check"></i><b>5.4.1</b> Multiplication rule of conditional probability</a></li>
<li class="chapter" data-level="5.4.2" data-path="probability-theory-and-applications.html"><a href="probability-theory-and-applications.html#law-of-total-probability"><i class="fa fa-check"></i><b>5.4.2</b> Law of total probability</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="probability-theory-and-applications.html"><a href="probability-theory-and-applications.html#contingency-tables"><i class="fa fa-check"></i><b>5.5</b> Contingency tables</a></li>
<li class="chapter" data-level="5.6" data-path="probability-theory-and-applications.html"><a href="probability-theory-and-applications.html#useful-resources-4"><i class="fa fa-check"></i><b>5.6</b> Useful resources</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html"><i class="fa fa-check"></i><b>6</b> Bayesian Statistical Inference</a>
<ul>
<li class="chapter" data-level="6.1" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#introduction"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#bayes-theorem"><i class="fa fa-check"></i><b>6.2</b> Bayes’ theorem</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#bayes-theorem-for-random-variables"><i class="fa fa-check"></i><b>6.2.1</b> Bayes’ theorem for random variables</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#the-likelihood-function"><i class="fa fa-check"></i><b>6.3</b> The likelihood function</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#different-types-and-structures"><i class="fa fa-check"></i><b>6.3.1</b> Different types and structures</a>
<ul>
<li class="chapter" data-level="6.3.1.1" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#count-data"><i class="fa fa-check"></i><b>6.3.1.1</b> Count data</a></li>
<li class="chapter" data-level="6.3.1.2" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#binary-data"><i class="fa fa-check"></i><b>6.3.1.2</b> Binary data</a></li>
<li class="chapter" data-level="6.3.1.3" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#proportional-data"><i class="fa fa-check"></i><b>6.3.1.3</b> Proportional data</a></li>
<li class="chapter" data-level="6.3.1.4" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#continuous-data"><i class="fa fa-check"></i><b>6.3.1.4</b> Continuous data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#prior-distribution"><i class="fa fa-check"></i><b>6.4</b> Prior distribution</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#conjugate-priors"><i class="fa fa-check"></i><b>6.4.1</b> Conjugate priors</a></li>
<li class="chapter" data-level="6.4.2" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#flat-improper-and-non-informative-priors"><i class="fa fa-check"></i><b>6.4.2</b> Flat, improper and non-informative priors</a></li>
<li class="chapter" data-level="6.4.3" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#informative-prior"><i class="fa fa-check"></i><b>6.4.3</b> Informative prior</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#overview-of-posterior-inference"><i class="fa fa-check"></i><b>6.5</b> Overview of posterior inference</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#markov-chain-monte-carlo-approach"><i class="fa fa-check"></i><b>6.5.1</b> Markov Chain Monte Carlo approach</a></li>
<li class="chapter" data-level="6.5.2" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#integrated-nested-laplace-approximation-approach"><i class="fa fa-check"></i><b>6.5.2</b> Integrated Nested Laplace Approximation approach</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#elicitation-of-priors"><i class="fa fa-check"></i><b>6.6</b> Elicitation of priors</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#priors-inla"><i class="fa fa-check"></i><b>6.6.1</b> Priors INLA</a>
<ul>
<li class="chapter" data-level="6.6.1.1" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#penalised-complexity-priors"><i class="fa fa-check"></i><b>6.6.1.1</b> Penalised Complexity priors</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#sampling-and-evaluating-the-posterior-density"><i class="fa fa-check"></i><b>6.7</b> Sampling and evaluating the posterior density</a></li>
<li class="chapter" data-level="6.8" data-path="bayesian-statistical-inference.html"><a href="bayesian-statistical-inference.html#useful-resources-5"><i class="fa fa-check"></i><b>6.8</b> Useful resources</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="introduction-to-small-area-population-estimation-and-modelling-sapem.html"><a href="introduction-to-small-area-population-estimation-and-modelling-sapem.html"><i class="fa fa-check"></i><b>7</b> Introduction to Small Area Population Estimation and Modelling (SAPEM)</a>
<ul>
<li class="chapter" data-level="7.1" data-path="introduction-to-small-area-population-estimation-and-modelling-sapem.html"><a href="introduction-to-small-area-population-estimation-and-modelling-sapem.html#small-area-population-estimation"><i class="fa fa-check"></i><b>7.1</b> Small area population estimation</a></li>
<li class="chapter" data-level="7.2" data-path="introduction-to-small-area-population-estimation-and-modelling-sapem.html"><a href="introduction-to-small-area-population-estimation-and-modelling-sapem.html#direct-estimation"><i class="fa fa-check"></i><b>7.2</b> Direct estimation</a></li>
<li class="chapter" data-level="7.3" data-path="introduction-to-small-area-population-estimation-and-modelling-sapem.html"><a href="introduction-to-small-area-population-estimation-and-modelling-sapem.html#indirect-estimation"><i class="fa fa-check"></i><b>7.3</b> Indirect estimation</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="introduction-to-small-area-population-estimation-and-modelling-sapem.html"><a href="introduction-to-small-area-population-estimation-and-modelling-sapem.html#approaches-for-creating-gridded-population-datasets"><i class="fa fa-check"></i><b>7.3.1</b> Approaches for creating gridded population datasets</a>
<ul>
<li class="chapter" data-level="7.3.1.1" data-path="introduction-to-small-area-population-estimation-and-modelling-sapem.html"><a href="introduction-to-small-area-population-estimation-and-modelling-sapem.html#top-down"><i class="fa fa-check"></i><b>7.3.1.1</b> Top-down</a></li>
<li class="chapter" data-level="7.3.1.2" data-path="introduction-to-small-area-population-estimation-and-modelling-sapem.html"><a href="introduction-to-small-area-population-estimation-and-modelling-sapem.html#bottom-up"><i class="fa fa-check"></i><b>7.3.1.2</b> Bottom-up</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="introduction-to-small-area-population-estimation-and-modelling-sapem.html"><a href="introduction-to-small-area-population-estimation-and-modelling-sapem.html#useful-resources-6"><i class="fa fa-check"></i><b>7.4</b> Useful resources</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html"><i class="fa fa-check"></i><b>8</b> Bayesian Hierarchical Population Modelling in R</a>
<ul>
<li class="chapter" data-level="8.1" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#data-sources"><i class="fa fa-check"></i><b>8.1</b> Data sources</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#population-data"><i class="fa fa-check"></i><b>8.1.1</b> Population data</a></li>
<li class="chapter" data-level="8.1.2" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#settlement-data"><i class="fa fa-check"></i><b>8.1.2</b> Settlement data</a></li>
<li class="chapter" data-level="8.1.3" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#other-sources"><i class="fa fa-check"></i><b>8.1.3</b> Other sources</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#data-cleaning-and-covariates-extraction"><i class="fa fa-check"></i><b>8.2</b> Data cleaning and covariates extraction</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#extracting-continuous-rasters"><i class="fa fa-check"></i><b>8.2.1</b> Extracting continuous rasters</a></li>
<li class="chapter" data-level="8.2.2" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#extracting-categorical-rasters"><i class="fa fa-check"></i><b>8.2.2</b> Extracting categorical rasters</a></li>
<li class="chapter" data-level="8.2.3" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#extracting-building-count"><i class="fa fa-check"></i><b>8.2.3</b> Extracting building count</a></li>
<li class="chapter" data-level="8.2.4" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#exracting-building-total-area"><i class="fa fa-check"></i><b>8.2.4</b> Exracting building total area</a></li>
<li class="chapter" data-level="8.2.5" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#adding-admin-area-names-to-the-data"><i class="fa fa-check"></i><b>8.2.5</b> Adding admin area names to the data</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#exploratory-analysis"><i class="fa fa-check"></i><b>8.3</b> Exploratory analysis</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#basic-visualisation"><i class="fa fa-check"></i><b>8.3.1</b> Basic visualisation</a></li>
<li class="chapter" data-level="8.3.2" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#geospatial-visualisation"><i class="fa fa-check"></i><b>8.3.2</b> Geospatial visualisation</a></li>
<li class="chapter" data-level="8.3.3" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#checking-for-nas"><i class="fa fa-check"></i><b>8.3.3</b> Checking for NAs</a></li>
<li class="chapter" data-level="8.3.4" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#checking-for-minimum-and-maximum-values"><i class="fa fa-check"></i><b>8.3.4</b> Checking for minimum and maximum values</a></li>
<li class="chapter" data-level="8.3.5" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#checking-the-distribution-of-categorical-variables"><i class="fa fa-check"></i><b>8.3.5</b> Checking the distribution of categorical variables</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#model-set-up"><i class="fa fa-check"></i><b>8.4</b> Model set-up</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#simple-linear-regression"><i class="fa fa-check"></i><b>8.4.1</b> Simple linear regression</a></li>
<li class="chapter" data-level="8.4.2" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#multiple-regression-1"><i class="fa fa-check"></i><b>8.4.2</b> Multiple regression</a></li>
<li class="chapter" data-level="8.4.3" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#generalised-linear-regression-1"><i class="fa fa-check"></i><b>8.4.3</b> Generalised linear regression</a></li>
<li class="chapter" data-level="8.4.4" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#fitting-fixed-effects-models-in-r-inla"><i class="fa fa-check"></i><b>8.4.4</b> Fitting fixed effects models in <code>R-INLA</code></a></li>
<li class="chapter" data-level="8.4.5" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#fitting-bayesian-hierarchical-mixed-effects-models-in-r-inla"><i class="fa fa-check"></i><b>8.4.5</b> Fitting Bayesian hierarchical mixed effects models in <code>R-INLA</code></a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#stan-mcmc-approach"><i class="fa fa-check"></i><b>8.5</b> STAN (MCMC) approach</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#metropolis-hastings-algorithm"><i class="fa fa-check"></i><b>8.5.1</b> Metropolis-Hastings algorithm</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#inla-and-inla-spde-approach"><i class="fa fa-check"></i><b>8.6</b> INLA and INLA-SPDE approach</a>
<ul>
<li class="chapter" data-level="8.6.1" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#mesh-construction"><i class="fa fa-check"></i><b>8.6.1</b> Mesh construction</a></li>
<li class="chapter" data-level="8.6.2" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#building-the-spde"><i class="fa fa-check"></i><b>8.6.2</b> Building the SPDE</a></li>
<li class="chapter" data-level="8.6.3" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#projection-matrix"><i class="fa fa-check"></i><b>8.6.3</b> Projection matrix</a></li>
<li class="chapter" data-level="8.6.4" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#data-location-indexing"><i class="fa fa-check"></i><b>8.6.4</b> Data location indexing</a></li>
<li class="chapter" data-level="8.6.5" data-path="bayesian-hierarchical-population-modelling-in-r.html"><a href="bayesian-hierarchical-population-modelling-in-r.html#projection-data"><i class="fa fa-check"></i><b>8.6.5</b> Projection data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="model-fit-checks-and-cross-validation.html"><a href="model-fit-checks-and-cross-validation.html"><i class="fa fa-check"></i><b>9</b> Model Fit Checks and Cross-Validation</a>
<ul>
<li class="chapter" data-level="9.1" data-path="model-fit-checks-and-cross-validation.html"><a href="model-fit-checks-and-cross-validation.html#model-assumption-checking"><i class="fa fa-check"></i><b>9.1</b> Model assumption checking</a></li>
<li class="chapter" data-level="9.2" data-path="model-fit-checks-and-cross-validation.html"><a href="model-fit-checks-and-cross-validation.html#model-selection-1"><i class="fa fa-check"></i><b>9.2</b> Model selection</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="model-fit-checks-and-cross-validation.html"><a href="model-fit-checks-and-cross-validation.html#watanabe-akaike-information-criterion-waic"><i class="fa fa-check"></i><b>9.2.1</b> Watanabe-Akaike Information Criterion (WAIC)</a></li>
<li class="chapter" data-level="9.2.2" data-path="model-fit-checks-and-cross-validation.html"><a href="model-fit-checks-and-cross-validation.html#deviance-information-criterion-dic"><i class="fa fa-check"></i><b>9.2.2</b> Deviance Information Criterion (DIC)</a></li>
<li class="chapter" data-level="9.2.3" data-path="model-fit-checks-and-cross-validation.html"><a href="model-fit-checks-and-cross-validation.html#conditional-predictive-ordinate-cpo"><i class="fa fa-check"></i><b>9.2.3</b> Conditional predictive ordinate (CPO)</a></li>
<li class="chapter" data-level="9.2.4" data-path="model-fit-checks-and-cross-validation.html"><a href="model-fit-checks-and-cross-validation.html#probability-integral-transform-pit"><i class="fa fa-check"></i><b>9.2.4</b> Probability Integral Transform (PIT)</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="model-fit-checks-and-cross-validation.html"><a href="model-fit-checks-and-cross-validation.html#cross-validation-1"><i class="fa fa-check"></i><b>9.3</b> Cross-validation</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="model-fit-checks-and-cross-validation.html"><a href="model-fit-checks-and-cross-validation.html#basic-cross-validation"><i class="fa fa-check"></i><b>9.3.1</b> Basic cross-validation</a></li>
<li class="chapter" data-level="9.3.2" data-path="model-fit-checks-and-cross-validation.html"><a href="model-fit-checks-and-cross-validation.html#k-fold-cross-validation-1"><i class="fa fa-check"></i><b>9.3.2</b> K-Fold Cross-Validation</a></li>
<li class="chapter" data-level="9.3.3" data-path="model-fit-checks-and-cross-validation.html"><a href="model-fit-checks-and-cross-validation.html#useful-resources-7"><i class="fa fa-check"></i><b>9.3.3</b> Useful resources</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="population-prediction-and-uncertainty-quantification.html"><a href="population-prediction-and-uncertainty-quantification.html"><i class="fa fa-check"></i><b>10</b> Population Prediction and Uncertainty Quantification</a>
<ul>
<li class="chapter" data-level="10.1" data-path="population-prediction-and-uncertainty-quantification.html"><a href="population-prediction-and-uncertainty-quantification.html#covariate-stacking"><i class="fa fa-check"></i><b>10.1</b> Covariate stacking</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="population-prediction-and-uncertainty-quantification.html"><a href="population-prediction-and-uncertainty-quantification.html#admin-names"><i class="fa fa-check"></i><b>10.1.1</b> Admin names</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="population-prediction-and-uncertainty-quantification.html"><a href="population-prediction-and-uncertainty-quantification.html#grid-cellpixel-level-prediction"><i class="fa fa-check"></i><b>10.2</b> Grid cell/pixel level prediction</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="population-prediction-and-uncertainty-quantification.html"><a href="population-prediction-and-uncertainty-quantification.html#pre-processing"><i class="fa fa-check"></i><b>10.2.1</b> Pre-processing</a></li>
<li class="chapter" data-level="10.2.2" data-path="population-prediction-and-uncertainty-quantification.html"><a href="population-prediction-and-uncertainty-quantification.html#inla-spde-approach"><i class="fa fa-check"></i><b>10.2.2</b> INLA-SPDE approach</a>
<ul>
<li class="chapter" data-level="10.2.2.1" data-path="population-prediction-and-uncertainty-quantification.html"><a href="population-prediction-and-uncertainty-quantification.html#predictions"><i class="fa fa-check"></i><b>10.2.2.1</b> Predictions</a></li>
</ul></li>
<li class="chapter" data-level="10.2.3" data-path="population-prediction-and-uncertainty-quantification.html"><a href="population-prediction-and-uncertainty-quantification.html#posterior-distribution-simulation"><i class="fa fa-check"></i><b>10.2.3</b> Posterior distribution simulation</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="population-prediction-and-uncertainty-quantification.html"><a href="population-prediction-and-uncertainty-quantification.html#aggregation-to-area-units-of-interest-and-uncertainty-quantification"><i class="fa fa-check"></i><b>10.3</b> Aggregation to area units of interest and uncertainty quantification</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="population-prediction-and-uncertainty-quantification.html"><a href="population-prediction-and-uncertainty-quantification.html#rasterising-the-predictions-at-grid-cell-level"><i class="fa fa-check"></i><b>10.3.1</b> Rasterising the predictions at grid cell level</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="population-prediction-and-uncertainty-quantification.html"><a href="population-prediction-and-uncertainty-quantification.html#useful-resources-8"><i class="fa fa-check"></i><b>10.4</b> Useful resources</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="age-sex-disaggregation.html"><a href="age-sex-disaggregation.html"><i class="fa fa-check"></i><b>11</b> Age-Sex Disaggregation</a>
<ul>
<li class="chapter" data-level="11.1" data-path="age-sex-disaggregation.html"><a href="age-sex-disaggregation.html#disaggregation-of-population-totals-by-age-sex-proportions"><i class="fa fa-check"></i><b>11.1</b> Disaggregation of population totals by age-sex proportions</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="age-sex-disaggregation.html"><a href="age-sex-disaggregation.html#unavailable-age-sex-data"><i class="fa fa-check"></i><b>11.1.1</b> Unavailable age-sex data</a></li>
<li class="chapter" data-level="11.1.2" data-path="age-sex-disaggregation.html"><a href="age-sex-disaggregation.html#available-age-sex-data"><i class="fa fa-check"></i><b>11.1.2</b> Available age-sex data</a>
<ul>
<li class="chapter" data-level="11.1.2.1" data-path="age-sex-disaggregation.html"><a href="age-sex-disaggregation.html#age-sex-disaggregation-1"><i class="fa fa-check"></i><b>11.1.2.1</b> Age-sex disaggregation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="age-sex-disaggregation.html"><a href="age-sex-disaggregation.html#useful-resources-9"><i class="fa fa-check"></i><b>11.2</b> Useful resources</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html"><i class="fa fa-check"></i><b>12</b> Exercise Solutions by Module</a>
<ul>
<li class="chapter" data-level="12.1" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#module-1"><i class="fa fa-check"></i><b>12.1</b> Module 1</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#general-exercises"><i class="fa fa-check"></i><b>12.1.1</b> General exercises</a></li>
<li class="chapter" data-level="12.1.2" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#end-of-module-exercises-3"><i class="fa fa-check"></i><b>12.1.2</b> End of module exercises</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#module-2"><i class="fa fa-check"></i><b>12.2</b> Module 2</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#general-exercises-1"><i class="fa fa-check"></i><b>12.2.1</b> General exercises</a></li>
<li class="chapter" data-level="12.2.2" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#end-of-module-exercises-4"><i class="fa fa-check"></i><b>12.2.2</b> End of module exercises</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#module-3"><i class="fa fa-check"></i><b>12.3</b> Module 3</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#general-exercises-2"><i class="fa fa-check"></i><b>12.3.1</b> General exercises</a></li>
<li class="chapter" data-level="12.3.2" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#end-of-module-exercises-5"><i class="fa fa-check"></i><b>12.3.2</b> End of module exercises</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#module-4"><i class="fa fa-check"></i><b>12.4</b> Module 4</a>
<ul>
<li class="chapter" data-level="12.4.1" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#general-exercises-3"><i class="fa fa-check"></i><b>12.4.1</b> General exercises</a></li>
</ul></li>
<li class="chapter" data-level="12.5" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#module-5"><i class="fa fa-check"></i><b>12.5</b> Module 5</a>
<ul>
<li class="chapter" data-level="12.5.1" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#general-exercises-4"><i class="fa fa-check"></i><b>12.5.1</b> General exercises</a></li>
<li class="chapter" data-level="12.5.2" data-path="exercise-solutions-by-module.html"><a href="exercise-solutions-by-module.html#general-exercises-5"><i class="fa fa-check"></i><b>12.5.2</b> General exercises</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">WorldPop Population Modelling Training Manual, Vol. I</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="model-fit-checks-and-cross-validation" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">9</span> Model Fit Checks and Cross-Validation<a href="model-fit-checks-and-cross-validation.html#model-fit-checks-and-cross-validation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This module expands on the methods discussed in earlier modules, detailing the model assumption checking methods, and different techniques for model selection. Additionally, this module covers cross-validation methods in more detail than in Module 4.</p>
<div id="model-assumption-checking" class="section level2 hasAnchor" number="9.1">
<h2><span class="header-section-number">9.1</span> Model assumption checking<a href="model-fit-checks-and-cross-validation.html#model-assumption-checking" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For this section, the data and model used follow on from Module 8, where the Cameroon data is explored and modelled. The resulting best model has covariates: <span class="math inline">\(x2, x16, x20, x24, x31, x36, x40\)</span>, which are used in the model <code>fdens4</code>. For more clarification, check the model set-up section of Module 8.</p>
<p>Once the chosen model is fitted, as mentioned in Module 4, it is important to check the validity of the model assumptions.</p>
<p>One method of doing this is to obtain the model residuals and plot a histogram of the residuals to test for normality. In the histogram below, there is evidence that the normality assumption is upheld with an approximate bell-curve shape to the histogram that is roughly symmetric.</p>
<div class="sourceCode" id="cb758"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb758-1"><a href="model-fit-checks-and-cross-validation.html#cb758-1" tabindex="-1"></a><span class="co">#get the model residuals</span></span>
<span id="cb758-2"><a href="model-fit-checks-and-cross-validation.html#cb758-2" tabindex="-1"></a>model_residuals <span class="ot">=</span> fdens4<span class="sc">$</span>residuals</span>
<span id="cb758-3"><a href="model-fit-checks-and-cross-validation.html#cb758-3" tabindex="-1"></a></span>
<span id="cb758-4"><a href="model-fit-checks-and-cross-validation.html#cb758-4" tabindex="-1"></a><span class="co">#plot the histogram of the  residuals to test for the normality of the residuals</span></span>
<span id="cb758-5"><a href="model-fit-checks-and-cross-validation.html#cb758-5" tabindex="-1"></a><span class="fu">hist</span>(model_residuals, <span class="at">col =</span> <span class="st">&quot;#004C92&quot;</span>, <span class="at">breaks =</span> <span class="dv">20</span>, </span>
<span id="cb758-6"><a href="model-fit-checks-and-cross-validation.html#cb758-6" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&quot;Histogram of model residuals&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;Model residuals&quot;</span>)</span></code></pre></div>
<p><img src="WorldPop_Training_Manual_files/figure-html/normality%20of%20residuals-1.png" width="672" /></p>
<p>Alternatively, a quantile-quantile, or Q-Q, plot can be used to test for the normality of the residuals with the functions <code>qqnorm()</code> and <code>qqline()</code>.</p>
<div class="sourceCode" id="cb759"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb759-1"><a href="model-fit-checks-and-cross-validation.html#cb759-1" tabindex="-1"></a><span class="co">#plot the Q-Q plot of the residuals to test for the normality of the residuals</span></span>
<span id="cb759-2"><a href="model-fit-checks-and-cross-validation.html#cb759-2" tabindex="-1"></a><span class="fu">qqnorm</span>(model_residuals)</span>
<span id="cb759-3"><a href="model-fit-checks-and-cross-validation.html#cb759-3" tabindex="-1"></a></span>
<span id="cb759-4"><a href="model-fit-checks-and-cross-validation.html#cb759-4" tabindex="-1"></a><span class="co">#plot the Q-Q line</span></span>
<span id="cb759-5"><a href="model-fit-checks-and-cross-validation.html#cb759-5" tabindex="-1"></a><span class="fu">qqline</span>(model_residuals)</span></code></pre></div>
<p><img src="WorldPop_Training_Manual_files/figure-html/qqplot-1.png" width="672" /></p>
<p>The homoscedasticity assumption, or the constant variance assumption, can be checked by plotting the residuals with the basic <code>plot()</code> function, adding a horizontal line to the plot with the <code>abline()</code> function to aid in the interpretation of results.</p>
<div class="sourceCode" id="cb760"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb760-1"><a href="model-fit-checks-and-cross-validation.html#cb760-1" tabindex="-1"></a><span class="co">#check for constant variance assumption (homoscedasticity)</span></span>
<span id="cb760-2"><a href="model-fit-checks-and-cross-validation.html#cb760-2" tabindex="-1"></a><span class="fu">plot</span>(model_residuals) </span>
<span id="cb760-3"><a href="model-fit-checks-and-cross-validation.html#cb760-3" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">3</span>) </span></code></pre></div>
<p><img src="WorldPop_Training_Manual_files/figure-html/constant%20variance%20plot-1.png" width="672" /></p>
<p>It is important that this assumption is met, as if not, the resulting standard errors may be biased leading to unreliable inferences from the coefficients. If the assumption of homoscedasticity is not met (the case of heteroscedasticity, the variance is not constant), robust standard errors can be computed, or the dependent variable can be transformed using weighted least squares (WLS) regression. For information on these methods, see <a href="https://evalf21.classes.andrewheiss.com/example/standard-errors/">Andrew Heiss</a> and <a href="https://www.r-bloggers.com/2023/12/conquering-unequal-variance-with-weighted-least-squares-in-r-a-practical-guide/">R-bloggers</a>.</p>
<p>To further demonstrate that this model is the preferred model, the generalised linear model with the selected significant covariates can be fitted against a nested (reduced) model. In the below code, a nested model is compared to the best model using the AIC where it can be seen that the AIC value for the model with the significant covariates found from the above workings is lower than for the nested model.</p>
<div class="sourceCode" id="cb761"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb761-1"><a href="model-fit-checks-and-cross-validation.html#cb761-1" tabindex="-1"></a><span class="co">#fit the glm </span></span>
<span id="cb761-2"><a href="model-fit-checks-and-cross-validation.html#cb761-2" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span>  <span class="fu">glm</span>(<span class="at">formula =</span> y <span class="sc">~</span> x2 <span class="sc">+</span> x16 <span class="sc">+</span> x20 <span class="sc">+</span> x24, <span class="at">family =</span> gaussian, </span>
<span id="cb761-3"><a href="model-fit-checks-and-cross-validation.html#cb761-3" tabindex="-1"></a>             <span class="at">data =</span> Data_CMR_std)</span>
<span id="cb761-4"><a href="model-fit-checks-and-cross-validation.html#cb761-4" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = y ~ x2 + x16 + x20 + x24, family = gaussian, data = Data_CMR_std)
## 
## Coefficients:
##             Estimate Std. Error  t value Pr(&gt;|t|)    
## (Intercept) -4.55781    0.03114 -146.374  &lt; 2e-16 ***
## x2          -0.34434    0.03250  -10.595  &lt; 2e-16 ***
## x16         -0.30925    0.03218   -9.611  &lt; 2e-16 ***
## x20          0.11053    0.03291    3.359 0.000801 ***
## x24          0.21823    0.03163    6.899 7.53e-12 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for gaussian family taken to be 1.540658)
## 
##     Null deviance: 2903.7  on 1588  degrees of freedom
## Residual deviance: 2440.4  on 1584  degrees of freedom
##   (3 observations deleted due to missingness)
## AIC: 5203.2
## 
## Number of Fisher Scoring iterations: 2</code></pre>
<div class="sourceCode" id="cb763"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb763-1"><a href="model-fit-checks-and-cross-validation.html#cb763-1" tabindex="-1"></a><span class="co">#best model</span></span>
<span id="cb763-2"><a href="model-fit-checks-and-cross-validation.html#cb763-2" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span>  <span class="fu">glm</span>(<span class="at">formula =</span> y <span class="sc">~</span> x2 <span class="sc">+</span> x16 <span class="sc">+</span> x20 <span class="sc">+</span> x24 <span class="sc">+</span> x31 <span class="sc">+</span> x36 <span class="sc">+</span> x40, </span>
<span id="cb763-3"><a href="model-fit-checks-and-cross-validation.html#cb763-3" tabindex="-1"></a>             <span class="at">family =</span> gaussian, <span class="at">data =</span> Data_CMR_std)</span>
<span id="cb763-4"><a href="model-fit-checks-and-cross-validation.html#cb763-4" tabindex="-1"></a><span class="fu">summary</span>(fit2)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = y ~ x2 + x16 + x20 + x24 + x31 + x36 + x40, family = gaussian, 
##     data = Data_CMR_std)
## 
## Coefficients:
##             Estimate Std. Error  t value Pr(&gt;|t|)    
## (Intercept) -4.55818    0.02961 -153.932  &lt; 2e-16 ***
## x2          -0.25674    0.03343   -7.680 2.78e-14 ***
## x16         -0.14195    0.03342   -4.247 2.29e-05 ***
## x20          0.16773    0.03194    5.251 1.71e-07 ***
## x24          0.10987    0.03130    3.510 0.000461 ***
## x31         -0.02331    0.03233   -0.721 0.470987    
## x36         -0.32647    0.03599   -9.070  &lt; 2e-16 ***
## x40          0.18504    0.03901    4.743 2.29e-06 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for gaussian family taken to be 1.393316)
## 
##     Null deviance: 2903.7  on 1588  degrees of freedom
## Residual deviance: 2202.8  on 1581  degrees of freedom
##   (3 observations deleted due to missingness)
## AIC: 5046.4
## 
## Number of Fisher Scoring iterations: 2</code></pre>
</div>
<div id="model-selection-1" class="section level2 hasAnchor" number="9.2">
<h2><span class="header-section-number">9.2</span> Model selection<a href="model-fit-checks-and-cross-validation.html#model-selection-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>When selecting the <em>best</em> model (out of the competing models), it is important to select the model with the highest predictive ability.</p>
<p>Model selection is introduced in Module 4, where methods such as the AIC, BIC and LRT are used. For example, the AIC can be used with the generalised linear models fitted in the previous section as follows.</p>
<div class="sourceCode" id="cb765"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb765-1"><a href="model-fit-checks-and-cross-validation.html#cb765-1" tabindex="-1"></a><span class="co">#compute the AIC statistics </span></span>
<span id="cb765-2"><a href="model-fit-checks-and-cross-validation.html#cb765-2" tabindex="-1"></a><span class="fu">AIC</span>(fit1)</span></code></pre></div>
<pre><code>## [1] 5203.159</code></pre>
<div class="sourceCode" id="cb767"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb767-1"><a href="model-fit-checks-and-cross-validation.html#cb767-1" tabindex="-1"></a><span class="fu">AIC</span>(fit2)</span></code></pre></div>
<pre><code>## [1] 5046.416</code></pre>
<p>It can be seen that <code>fit2</code> has a notably smaller AIC value and therefore, that is the model which should be selected.</p>
<p>However, these are not the only approaches that are available, with other methods more commonly used for Bayesian model selection.</p>
<div id="watanabe-akaike-information-criterion-waic" class="section level3 hasAnchor" number="9.2.1">
<h3><span class="header-section-number">9.2.1</span> Watanabe-Akaike Information Criterion (WAIC)<a href="model-fit-checks-and-cross-validation.html#watanabe-akaike-information-criterion-waic" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The WAIC (also known as the Widely Applicable information criterion) is a generalised version of the AIC that is commonly used for Bayesian model selection. This approach is often preferred when comparing Bayesian and complex models as instead of averaging over a point estimate (like the AIC and BIC), it averages over the posterior distribution, returning more robust and accurate results.</p>
<p>A value that can be used to compare the competing models is constructed through combining a penalty term derived from the estimated effective number of parameters with the expected log predictive densities for all the data points. When the data is not correlated, this method can be used as an alternative to cross-validation, and the method is only appropriate if there is no spatial or temporal auto-correlation. See <a href="https://www.nature.com/articles/s41598-024-66643-4#:~:text=One%20common%20method%20used%20for%20Bayesian%20model%20selection,value%20that%20can%20be%20compared%20between%20alternative%20models.">Nature</a> or <a href="http://www.stat.columbia.edu/~gelman/research/unpublished/loo_stan.pdf">Columbia</a> for more information.</p>
<p>When fitting a model with the <code>inla()</code> function, the argument <code>control.compute</code> can be included with a list of variables you wish to compute and return with the model. This is demonstrated in Module 6, wherein the argument is specified as <code>control.compute = list(waic = TRUE))</code>.</p>
<p>This is seen in Module 6 with the following code.</p>
<div class="sourceCode" id="cb769"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb769-1"><a href="model-fit-checks-and-cross-validation.html#cb769-1" tabindex="-1"></a><span class="co">#fit the chosen model and set WAIC to be computed</span></span>
<span id="cb769-2"><a href="model-fit-checks-and-cross-validation.html#cb769-2" tabindex="-1"></a>form_pop1a <span class="ot">&lt;-</span> <span class="fu">log</span>(Total_Pop) <span class="sc">~</span> x2 <span class="sc">+</span> x16 <span class="sc">+</span> x20 <span class="sc">+</span> x24 <span class="sc">+</span> <span class="sc">+</span>x31 <span class="sc">+</span> x36 <span class="sc">+</span> x40 </span>
<span id="cb769-3"><a href="model-fit-checks-and-cross-validation.html#cb769-3" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(form_pop1a,</span>
<span id="cb769-4"><a href="model-fit-checks-and-cross-validation.html#cb769-4" tabindex="-1"></a>              <span class="at">data =</span> <span class="fu">data.frame</span>(Data_CMR_std), <span class="co"># Data_CMR</span></span>
<span id="cb769-5"><a href="model-fit-checks-and-cross-validation.html#cb769-5" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">&quot;normal&quot;</span>,</span>
<span id="cb769-6"><a href="model-fit-checks-and-cross-validation.html#cb769-6" tabindex="-1"></a>              <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb769-7"><a href="model-fit-checks-and-cross-validation.html#cb769-7" tabindex="-1"></a>              <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> <span class="cn">TRUE</span>, <span class="at">waic =</span> <span class="cn">TRUE</span>, <span class="at">cpo =</span> <span class="cn">TRUE</span>, </span>
<span id="cb769-8"><a href="model-fit-checks-and-cross-validation.html#cb769-8" tabindex="-1"></a>                                     <span class="at">config =</span> <span class="cn">TRUE</span>) </span>
<span id="cb769-9"><a href="model-fit-checks-and-cross-validation.html#cb769-9" tabindex="-1"></a>)</span></code></pre></div>
<p>To extract just the WAIC statistic from the model, either <code>$waic[1]</code> can be used after giving the model name, or the function <code>summary()</code> with the model of interest as the argument can be used to return the WAIC statistic alongside other potentially of interest information. Both of these options are given below. As with the standard AIC (and BIC), the WAIC is used for comparing nested models, where the model with the lower WAIC value is the better fitting model.</p>
<div class="sourceCode" id="cb770"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb770-1"><a href="model-fit-checks-and-cross-validation.html#cb770-1" tabindex="-1"></a><span class="co">#extracting WAIC</span></span>
<span id="cb770-2"><a href="model-fit-checks-and-cross-validation.html#cb770-2" tabindex="-1"></a>mod1<span class="sc">$</span>waic[<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## $waic
## [1] 3078.578</code></pre>
<div class="sourceCode" id="cb772"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb772-1"><a href="model-fit-checks-and-cross-validation.html#cb772-1" tabindex="-1"></a><span class="co">#using summary function </span></span>
<span id="cb772-2"><a href="model-fit-checks-and-cross-validation.html#cb772-2" tabindex="-1"></a><span class="fu">summary</span>(mod1)</span></code></pre></div>
<pre><code>## Time used:
##     Pre = 0.466, Running = 0.642, Post = 0.199, Total = 1.31 
## Fixed effects:
##               mean    sd 0.025quant 0.5quant 0.975quant   mode kld
## (Intercept)  6.815 0.016      6.784    6.815      6.847  6.815   0
## x2           0.009 0.018     -0.026    0.009      0.044  0.009   0
## x16         -0.083 0.018     -0.118   -0.083     -0.048 -0.083   0
## x20          0.022 0.017     -0.011    0.022      0.056  0.022   0
## x24         -0.002 0.017     -0.035   -0.002      0.031 -0.002   0
## x31         -0.144 0.017     -0.178   -0.144     -0.110 -0.144   0
## x36         -0.103 0.019     -0.141   -0.103     -0.065 -0.103   0
## x40         -0.017 0.021     -0.058   -0.017      0.024 -0.017   0
## 
## Model hyperparameters:
##                                         mean    sd 0.025quant 0.5quant 0.975quant mode
## Precision for the Gaussian observations 2.49 0.089       2.32     2.49       2.67 2.49
## 
## Deviance Information Criterion (DIC) ...............: 3074.66
## Deviance Information Criterion (DIC, saturated) ....: 1603.22
## Effective number of parameters .....................: 9.00
## 
## Watanabe-Akaike information criterion (WAIC) ...: 3078.58
## Effective number of parameters .................: 12.70
## 
## Marginal log-Likelihood:  -1595.61 
## CPO, PIT is computed 
## Posterior summaries for the linear predictor and the fitted values are computed
## (Posterior marginals needs also &#39;control.compute=list(return.marginals.predictor=TRUE)&#39;)</code></pre>
</div>
<div id="deviance-information-criterion-dic" class="section level3 hasAnchor" number="9.2.2">
<h3><span class="header-section-number">9.2.2</span> Deviance Information Criterion (DIC)<a href="model-fit-checks-and-cross-validation.html#deviance-information-criterion-dic" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Similarly to the WAIC, the DIC is commonly used for comparison of Bayesian models for model selection. This criterion is a hierarchical modelling generalisation of the AIC and is particularly useful in cases where the Markov chain Monte Carlo (MCMC) methods have been used for obtaining the posterior distributions of the models. The main difference from the AIC is that instead of the maximised log-likelihood value used, the DIC uses the log-likelihood evaluated at the Bayes estimate of <span class="math inline">\(\hat{\theta}\)</span>. Additionally, the penalty term in the AIC is replaced with the estimated effective number of parameters.</p>
<p>As with the WAIC, the DIC can be computed within the <code>inla()</code> function by including the argument <code>control.compute</code> specified as <code>control.compute = list(dic = TRUE))</code>. This is also shown in Module 6 with the following code.</p>
<div class="sourceCode" id="cb774"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb774-1"><a href="model-fit-checks-and-cross-validation.html#cb774-1" tabindex="-1"></a><span class="co">#fit the chosen model and set DIC to be computed</span></span>
<span id="cb774-2"><a href="model-fit-checks-and-cross-validation.html#cb774-2" tabindex="-1"></a>form_pop1a <span class="ot">&lt;-</span> <span class="fu">log</span>(Total_Pop) <span class="sc">~</span> x2 <span class="sc">+</span> x16 <span class="sc">+</span> x20 <span class="sc">+</span> x24 <span class="sc">+</span> x31 <span class="sc">+</span> x36 <span class="sc">+</span> x40</span>
<span id="cb774-3"><a href="model-fit-checks-and-cross-validation.html#cb774-3" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(form_pop1a,</span>
<span id="cb774-4"><a href="model-fit-checks-and-cross-validation.html#cb774-4" tabindex="-1"></a>              <span class="at">data =</span> <span class="fu">data.frame</span>(Data_CMR_std),</span>
<span id="cb774-5"><a href="model-fit-checks-and-cross-validation.html#cb774-5" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">&quot;normal&quot;</span>,</span>
<span id="cb774-6"><a href="model-fit-checks-and-cross-validation.html#cb774-6" tabindex="-1"></a>              <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb774-7"><a href="model-fit-checks-and-cross-validation.html#cb774-7" tabindex="-1"></a>              <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> <span class="cn">TRUE</span>, <span class="at">waic =</span> <span class="cn">TRUE</span>, <span class="at">cpo =</span> <span class="cn">TRUE</span>, </span>
<span id="cb774-8"><a href="model-fit-checks-and-cross-validation.html#cb774-8" tabindex="-1"></a>                                     <span class="at">config =</span> <span class="cn">TRUE</span>) </span>
<span id="cb774-9"><a href="model-fit-checks-and-cross-validation.html#cb774-9" tabindex="-1"></a>)</span></code></pre></div>
<p>The methods to extract the WAIC from the model are similar to those for extracting the DIC, for example, <code>$dic[1]</code> can be used following the model name or the <code>summary()</code> function with the model of interest as the argument. As an example, the former method is given below for the above model. Similarly to the WAIC statistic, DIC is used for comparing the fit of nested models and the model with the lowest DIC value is the better fitting model.</p>
<div class="sourceCode" id="cb775"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb775-1"><a href="model-fit-checks-and-cross-validation.html#cb775-1" tabindex="-1"></a><span class="co">#compute the DIC</span></span>
<span id="cb775-2"><a href="model-fit-checks-and-cross-validation.html#cb775-2" tabindex="-1"></a>mod1<span class="sc">$</span>dic[<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## $dic
## [1] 3074.664</code></pre>
<p>For more information and a manual implementation in R, see <a href="https://dm13450.github.io/2018/01/18/DIC.html">Dean Markwick</a>.</p>
</div>
<div id="conditional-predictive-ordinate-cpo" class="section level3 hasAnchor" number="9.2.3">
<h3><span class="header-section-number">9.2.3</span> Conditional predictive ordinate (CPO)<a href="model-fit-checks-and-cross-validation.html#conditional-predictive-ordinate-cpo" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The conditional predictive ordinate is the leave-one-out cross-validation predictive density (also described as a cross-validatory criterion), conducting an observation-specific measure of the fit of the model. The CPO is computed for each observation, where when the model is fitted using all data but <span class="math inline">\(y_i\)</span> (leave-one-out cross-validation), the CPO value is given as the posterior probability of observing that observation. The CPO allows for detection of unexpected or unusual observations, where whilst large CPO values correspond to the model fitting the observation well, a small CPO value indicates that the model fits that observation poorly, possibly indicating an outlier.</p>
<p>This approach requires some MCMC simulation to sample from the posterior simulation, however, this is the only simulation required unlike with other cross-validation and posterior-predictive approaches, making it a more computationally efficient and attractive approach to use.</p>
<p>As with both the WAIC and DIC, Module 6 provides an example of this being computed within the <code>inla()</code> function through using the argument <code>control.compute = list(cpo = TRUE)</code>, where the example code is as follows.</p>
<div class="sourceCode" id="cb777"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb777-1"><a href="model-fit-checks-and-cross-validation.html#cb777-1" tabindex="-1"></a><span class="co">#fit the chosen model and set CPO to be computed</span></span>
<span id="cb777-2"><a href="model-fit-checks-and-cross-validation.html#cb777-2" tabindex="-1"></a>form_pop1a <span class="ot">&lt;-</span> <span class="fu">log</span>(Total_Pop) <span class="sc">~</span> x2 <span class="sc">+</span> x16 <span class="sc">+</span> x20 <span class="sc">+</span> x24 <span class="sc">+</span> x31 <span class="sc">+</span> x36 <span class="sc">+</span> x40</span>
<span id="cb777-3"><a href="model-fit-checks-and-cross-validation.html#cb777-3" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(form_pop1a,</span>
<span id="cb777-4"><a href="model-fit-checks-and-cross-validation.html#cb777-4" tabindex="-1"></a>              <span class="at">data =</span> <span class="fu">data.frame</span>(Data_CMR_std),</span>
<span id="cb777-5"><a href="model-fit-checks-and-cross-validation.html#cb777-5" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">&quot;normal&quot;</span>, </span>
<span id="cb777-6"><a href="model-fit-checks-and-cross-validation.html#cb777-6" tabindex="-1"></a>              <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb777-7"><a href="model-fit-checks-and-cross-validation.html#cb777-7" tabindex="-1"></a>              <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> <span class="cn">TRUE</span>, <span class="at">waic =</span> <span class="cn">TRUE</span>, <span class="at">cpo =</span> <span class="cn">TRUE</span>, </span>
<span id="cb777-8"><a href="model-fit-checks-and-cross-validation.html#cb777-8" tabindex="-1"></a>                                     <span class="at">config =</span> <span class="cn">TRUE</span>)</span>
<span id="cb777-9"><a href="model-fit-checks-and-cross-validation.html#cb777-9" tabindex="-1"></a>)</span></code></pre></div>
<p>Similarly to the other model selection methods, the CPO can be extracted through using <code>$cpo[1]</code> or <code>$cpo$cpo</code> following the name of the chosen model.</p>
<p>To identify any potential outlier observations, the CPO values can be plotted, with each value numbered to the corresponding observation index number for ease of identification.</p>
<div class="sourceCode" id="cb778"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb778-1"><a href="model-fit-checks-and-cross-validation.html#cb778-1" tabindex="-1"></a><span class="co">#set n to be the total number of observations</span></span>
<span id="cb778-2"><a href="model-fit-checks-and-cross-validation.html#cb778-2" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Data_CMR)</span>
<span id="cb778-3"><a href="model-fit-checks-and-cross-validation.html#cb778-3" tabindex="-1"></a></span>
<span id="cb778-4"><a href="model-fit-checks-and-cross-validation.html#cb778-4" tabindex="-1"></a><span class="co">#extract the CPO values</span></span>
<span id="cb778-5"><a href="model-fit-checks-and-cross-validation.html#cb778-5" tabindex="-1"></a>cpo_values <span class="ot">&lt;-</span> mod1<span class="sc">$</span>cpo<span class="sc">$</span>cpo</span>
<span id="cb778-6"><a href="model-fit-checks-and-cross-validation.html#cb778-6" tabindex="-1"></a></span>
<span id="cb778-7"><a href="model-fit-checks-and-cross-validation.html#cb778-7" tabindex="-1"></a><span class="co">#plot the CPO values</span></span>
<span id="cb778-8"><a href="model-fit-checks-and-cross-validation.html#cb778-8" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span>n, cpo_values, <span class="at">ylab =</span> <span class="st">&quot;CPO&quot;</span>, <span class="at">type =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb778-9"><a href="model-fit-checks-and-cross-validation.html#cb778-9" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">1</span><span class="sc">:</span>n, cpo_values, <span class="dv">1</span><span class="sc">:</span>n)</span></code></pre></div>
<p><img src="WorldPop_Training_Manual_files/figure-html/CPO%20plot-1.png" width="672" /></p>
<p>Given the large number of observations, the potential outlier observations cannot be easily detected from the resulting plot, to simplify this, the <span class="math inline">\(y\)</span>-axis can be limited to only show the very small CPO values as follows.</p>
<div class="sourceCode" id="cb779"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb779-1"><a href="model-fit-checks-and-cross-validation.html#cb779-1" tabindex="-1"></a><span class="co">#plot the CPO values</span></span>
<span id="cb779-2"><a href="model-fit-checks-and-cross-validation.html#cb779-2" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span>n, cpo_values, <span class="at">ylab =</span> <span class="st">&quot;CPO&quot;</span>, <span class="at">type =</span> <span class="st">&quot;n&quot;</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.01</span>))</span>
<span id="cb779-3"><a href="model-fit-checks-and-cross-validation.html#cb779-3" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">1</span><span class="sc">:</span>n, cpo_values, <span class="dv">1</span><span class="sc">:</span>n)</span></code></pre></div>
<p><img src="WorldPop_Training_Manual_files/figure-html/CPO%20outliers-1.png" width="672" /></p>
<p>The very small observations can then be extracted through selecting the ‘threshold’ for which values will be classified as outliers, and using the <code>which()</code> function to select the indices of each outlier value.</p>
<div class="sourceCode" id="cb780"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb780-1"><a href="model-fit-checks-and-cross-validation.html#cb780-1" tabindex="-1"></a><span class="co">#extract outliers</span></span>
<span id="cb780-2"><a href="model-fit-checks-and-cross-validation.html#cb780-2" tabindex="-1"></a><span class="fu">which</span>(cpo_values <span class="sc">&lt;</span> <span class="fl">0.005</span>)</span></code></pre></div>
<pre><code>##  [1]  142  225  228  231  234  260  268  319  368  412  438  713  744  745  756  757  808  865  890  940
## [21] 1147 1234 1252 1302 1314 1334 1399</code></pre>
<p>For more information on CPO, see <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3985471/">Posterior Predictive Bayesian Phylogenetic Model Selection</a>.</p>
</div>
<div id="probability-integral-transform-pit" class="section level3 hasAnchor" number="9.2.4">
<h3><span class="header-section-number">9.2.4</span> Probability Integral Transform (PIT)<a href="model-fit-checks-and-cross-validation.html#probability-integral-transform-pit" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The probability integral transform (or predictive integral transform, PIT) is another criterion that can be used for model selection. For each observation, the PIT measures the probability of a new response value being lower than the observed response value using a model that uses the rest of the data (also a leave-one-out approach). In the case where the model represents the observations well, the resulting (ordered) PIT values should approximately follow a uniform distribution.</p>
<p>The PIT is computed as part of the CPO within the <code>inla()</code> function, where it is confirmed whether or not the PIT is computed in the model in the <code>sumamry()</code> function, as seen below for the model given as an example in Module 6.</p>
<div class="sourceCode" id="cb782"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb782-1"><a href="model-fit-checks-and-cross-validation.html#cb782-1" tabindex="-1"></a><span class="co">#summary of chosen model for PIT</span></span>
<span id="cb782-2"><a href="model-fit-checks-and-cross-validation.html#cb782-2" tabindex="-1"></a><span class="fu">summary</span>(mod1)</span></code></pre></div>
<pre><code>## Time used:
##     Pre = 0.466, Running = 0.642, Post = 0.199, Total = 1.31 
## Fixed effects:
##               mean    sd 0.025quant 0.5quant 0.975quant   mode kld
## (Intercept)  6.815 0.016      6.784    6.815      6.847  6.815   0
## x2           0.009 0.018     -0.026    0.009      0.044  0.009   0
## x16         -0.083 0.018     -0.118   -0.083     -0.048 -0.083   0
## x20          0.022 0.017     -0.011    0.022      0.056  0.022   0
## x24         -0.002 0.017     -0.035   -0.002      0.031 -0.002   0
## x31         -0.144 0.017     -0.178   -0.144     -0.110 -0.144   0
## x36         -0.103 0.019     -0.141   -0.103     -0.065 -0.103   0
## x40         -0.017 0.021     -0.058   -0.017      0.024 -0.017   0
## 
## Model hyperparameters:
##                                         mean    sd 0.025quant 0.5quant 0.975quant mode
## Precision for the Gaussian observations 2.49 0.089       2.32     2.49       2.67 2.49
## 
## Deviance Information Criterion (DIC) ...............: 3074.66
## Deviance Information Criterion (DIC, saturated) ....: 1603.22
## Effective number of parameters .....................: 9.00
## 
## Watanabe-Akaike information criterion (WAIC) ...: 3078.58
## Effective number of parameters .................: 12.70
## 
## Marginal log-Likelihood:  -1595.61 
## CPO, PIT is computed 
## Posterior summaries for the linear predictor and the fitted values are computed
## (Posterior marginals needs also &#39;control.compute=list(return.marginals.predictor=TRUE)&#39;)</code></pre>
<p>The PIT values can be extracted from the model through using <code>$cpo[2]</code> or <code>$cpo$pit</code> following from the name of the chosen model, demonstrated in the below code, where the PIT values are plotted to test the fit of the model.</p>
<div class="sourceCode" id="cb784"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb784-1"><a href="model-fit-checks-and-cross-validation.html#cb784-1" tabindex="-1"></a><span class="co">#extract PIT values </span></span>
<span id="cb784-2"><a href="model-fit-checks-and-cross-validation.html#cb784-2" tabindex="-1"></a>pit_values <span class="ot">&lt;-</span> mod1<span class="sc">$</span>cpo<span class="sc">$</span>pit</span>
<span id="cb784-3"><a href="model-fit-checks-and-cross-validation.html#cb784-3" tabindex="-1"></a></span>
<span id="cb784-4"><a href="model-fit-checks-and-cross-validation.html#cb784-4" tabindex="-1"></a><span class="co">#compute uniform quantiles</span></span>
<span id="cb784-5"><a href="model-fit-checks-and-cross-validation.html#cb784-5" tabindex="-1"></a>uniform_quant <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span>n)<span class="sc">/</span>(n<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb784-6"><a href="model-fit-checks-and-cross-validation.html#cb784-6" tabindex="-1"></a></span>
<span id="cb784-7"><a href="model-fit-checks-and-cross-validation.html#cb784-7" tabindex="-1"></a><span class="co">#plot the PIT values</span></span>
<span id="cb784-8"><a href="model-fit-checks-and-cross-validation.html#cb784-8" tabindex="-1"></a><span class="fu">plot</span>(uniform_quant, <span class="fu">sort</span>(pit_values), <span class="at">xlab =</span> <span class="st">&quot;Uniform quantiles&quot;</span>, </span>
<span id="cb784-9"><a href="model-fit-checks-and-cross-validation.html#cb784-9" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">&quot;Ordered PIT values&quot;</span>)</span>
<span id="cb784-10"><a href="model-fit-checks-and-cross-validation.html#cb784-10" tabindex="-1"></a><span class="fu">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span></code></pre></div>
<p><img src="WorldPop_Training_Manual_files/figure-html/PIT%20uniform-1.png" width="672" /></p>
<p>It can be seen that the model fits the data reasonably well, given that the resulting plot of the PIT values is approximately uniformly distributed with no obvious outlier values.</p>
<p>For more information, see <a href="https://becarioprecario.bitbucket.io/inla-gitbook/ch-INLA.html">Bayesian inference with INLA</a>.</p>
</div>
</div>
<div id="cross-validation-1" class="section level2 hasAnchor" number="9.3">
<h2><span class="header-section-number">9.3</span> Cross-validation<a href="model-fit-checks-and-cross-validation.html#cross-validation-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>An introduction to cross-validation methods is given in Module 4, where a frequentist approach is taken. This section will cover basic cross-validation methods, in addition to the k-fold and leave-one-out cross-validation methods previously covered, however, with the application being to geospatial data (the Cameroon dataset following on from Module 8), INLA models and a Bayesian approach.</p>
<div id="basic-cross-validation" class="section level3 hasAnchor" number="9.3.1">
<h3><span class="header-section-number">9.3.1</span> Basic cross-validation<a href="model-fit-checks-and-cross-validation.html#basic-cross-validation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To begin with the basic cross-validation process, the data first needs to be randomly split into two, a training set and a test set. In this case, the training dataset contains 80% of the data and the test set contains the remaining 20% of the data.</p>
<div class="sourceCode" id="cb785"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb785-1"><a href="model-fit-checks-and-cross-validation.html#cb785-1" tabindex="-1"></a><span class="co">#set the seed for reproducibility</span></span>
<span id="cb785-2"><a href="model-fit-checks-and-cross-validation.html#cb785-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb785-3"><a href="model-fit-checks-and-cross-validation.html#cb785-3" tabindex="-1"></a></span>
<span id="cb785-4"><a href="model-fit-checks-and-cross-validation.html#cb785-4" tabindex="-1"></a><span class="co">#find how large 80% of the data is</span></span>
<span id="cb785-5"><a href="model-fit-checks-and-cross-validation.html#cb785-5" tabindex="-1"></a>n_train <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(<span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(Data_CMR_std))</span>
<span id="cb785-6"><a href="model-fit-checks-and-cross-validation.html#cb785-6" tabindex="-1"></a></span>
<span id="cb785-7"><a href="model-fit-checks-and-cross-validation.html#cb785-7" tabindex="-1"></a><span class="co">#sample the indices for the training data</span></span>
<span id="cb785-8"><a href="model-fit-checks-and-cross-validation.html#cb785-8" tabindex="-1"></a>train_sample <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(Data_CMR_std)), n_train)</span>
<span id="cb785-9"><a href="model-fit-checks-and-cross-validation.html#cb785-9" tabindex="-1"></a></span>
<span id="cb785-10"><a href="model-fit-checks-and-cross-validation.html#cb785-10" tabindex="-1"></a><span class="co">#sample the training data</span></span>
<span id="cb785-11"><a href="model-fit-checks-and-cross-validation.html#cb785-11" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> Data_CMR_std[train_sample, ]</span>
<span id="cb785-12"><a href="model-fit-checks-and-cross-validation.html#cb785-12" tabindex="-1"></a></span>
<span id="cb785-13"><a href="model-fit-checks-and-cross-validation.html#cb785-13" tabindex="-1"></a><span class="co">#sample the test data</span></span>
<span id="cb785-14"><a href="model-fit-checks-and-cross-validation.html#cb785-14" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> Data_CMR_std[<span class="sc">-</span>train_sample, ]</span></code></pre></div>
<p>Once the data has been split, the preferred model from above can be fitted on the training data (to ‘train’ the model). This can be done with the <code>glm()</code> as above.</p>
<div class="sourceCode" id="cb786"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb786-1"><a href="model-fit-checks-and-cross-validation.html#cb786-1" tabindex="-1"></a><span class="co">#fit the training model</span></span>
<span id="cb786-2"><a href="model-fit-checks-and-cross-validation.html#cb786-2" tabindex="-1"></a>train_model <span class="ot">&lt;-</span>  <span class="fu">glm</span>(<span class="at">formula =</span> y <span class="sc">~</span> x2 <span class="sc">+</span> x16 <span class="sc">+</span> x20 <span class="sc">+</span> x24 <span class="sc">+</span> x31 <span class="sc">+</span> x36 <span class="sc">+</span> x40, </span>
<span id="cb786-3"><a href="model-fit-checks-and-cross-validation.html#cb786-3" tabindex="-1"></a>             <span class="at">family =</span> gaussian, <span class="at">data =</span> train_data)</span></code></pre></div>
<p>As discussed in Module 4, predicted values can be computed using two methods. The simplest way is to use the <code>predict()</code> function, including the training model and test dataset as arguments. Alternatively, the prediction can be done manually through finding the coefficients for the best model and then manually multiplying the model coefficients to the corresponding covariates from the test data. To demonstrate that both methods produce the comparable results, a data frame can be created to compare the predicted values from each method side-by-side.</p>
<div class="sourceCode" id="cb787"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb787-1"><a href="model-fit-checks-and-cross-validation.html#cb787-1" tabindex="-1"></a><span class="co">#predictions with function</span></span>
<span id="cb787-2"><a href="model-fit-checks-and-cross-validation.html#cb787-2" tabindex="-1"></a>pred_w_func <span class="ot">&lt;-</span> <span class="fu">predict</span>(train_model, test_data)</span>
<span id="cb787-3"><a href="model-fit-checks-and-cross-validation.html#cb787-3" tabindex="-1"></a></span>
<span id="cb787-4"><a href="model-fit-checks-and-cross-validation.html#cb787-4" tabindex="-1"></a><span class="co">#predictions manually</span></span>
<span id="cb787-5"><a href="model-fit-checks-and-cross-validation.html#cb787-5" tabindex="-1"></a>coeffs <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(train_model)</span>
<span id="cb787-6"><a href="model-fit-checks-and-cross-validation.html#cb787-6" tabindex="-1"></a>pred_manual <span class="ot">&lt;-</span>  coeffs[<span class="dv">1</span>] <span class="sc">+</span> coeffs[<span class="dv">2</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x2 <span class="sc">+</span> coeffs[<span class="dv">3</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x16 <span class="sc">+</span></span>
<span id="cb787-7"><a href="model-fit-checks-and-cross-validation.html#cb787-7" tabindex="-1"></a>  coeffs[<span class="dv">4</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x20 <span class="sc">+</span> coeffs[<span class="dv">5</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x24 <span class="sc">+</span> coeffs[<span class="dv">6</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x31 <span class="sc">+</span></span>
<span id="cb787-8"><a href="model-fit-checks-and-cross-validation.html#cb787-8" tabindex="-1"></a>  coeffs[<span class="dv">7</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x36 <span class="sc">+</span> coeffs[<span class="dv">8</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x40</span>
<span id="cb787-9"><a href="model-fit-checks-and-cross-validation.html#cb787-9" tabindex="-1"></a></span>
<span id="cb787-10"><a href="model-fit-checks-and-cross-validation.html#cb787-10" tabindex="-1"></a><span class="co">#compare the predictions found using the two methods</span></span>
<span id="cb787-11"><a href="model-fit-checks-and-cross-validation.html#cb787-11" tabindex="-1"></a>compare_preds <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Manual =</span> pred_manual, </span>
<span id="cb787-12"><a href="model-fit-checks-and-cross-validation.html#cb787-12" tabindex="-1"></a>                  <span class="at">Automatic =</span> pred_w_func)</span>
<span id="cb787-13"><a href="model-fit-checks-and-cross-validation.html#cb787-13" tabindex="-1"></a><span class="fu">head</span>(compare_preds)</span></code></pre></div>
<pre><code>##       Manual Automatic
## 7  -4.841221 -4.841221
## 10 -5.499207 -5.499207
## 14 -4.207881 -4.207881
## 22 -5.169066 -5.169066
## 25 -5.034028 -5.034028
## 33 -4.560108 -4.560108</code></pre>
<p>To further compare the results, a scatter plot and a box plot can be produced.</p>
<div class="sourceCode" id="cb789"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb789-1"><a href="model-fit-checks-and-cross-validation.html#cb789-1" tabindex="-1"></a><span class="co">#put the plots side-by-side</span></span>
<span id="cb789-2"><a href="model-fit-checks-and-cross-validation.html#cb789-2" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb789-3"><a href="model-fit-checks-and-cross-validation.html#cb789-3" tabindex="-1"></a></span>
<span id="cb789-4"><a href="model-fit-checks-and-cross-validation.html#cb789-4" tabindex="-1"></a><span class="co">#scatter plot</span></span>
<span id="cb789-5"><a href="model-fit-checks-and-cross-validation.html#cb789-5" tabindex="-1"></a><span class="fu">plot</span>(pred_manual, pred_w_func,</span>
<span id="cb789-6"><a href="model-fit-checks-and-cross-validation.html#cb789-6" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;red&quot;</span>),</span>
<span id="cb789-7"><a href="model-fit-checks-and-cross-validation.html#cb789-7" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;Manual&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;Automatic&quot;</span>)</span>
<span id="cb789-8"><a href="model-fit-checks-and-cross-validation.html#cb789-8" tabindex="-1"></a></span>
<span id="cb789-9"><a href="model-fit-checks-and-cross-validation.html#cb789-9" tabindex="-1"></a><span class="co">#box plot</span></span>
<span id="cb789-10"><a href="model-fit-checks-and-cross-validation.html#cb789-10" tabindex="-1"></a><span class="fu">boxplot</span>(pred_manual, pred_w_func,</span>
<span id="cb789-11"><a href="model-fit-checks-and-cross-validation.html#cb789-11" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;red&quot;</span>))</span></code></pre></div>
<p><img src="WorldPop_Training_Manual_files/figure-html/comparison%20plots-1.png" width="672" /></p>
<p>Model fit metrics such as Mean Absolute Error (MAE), Root Mean Square Error (RMSE), bias and correlation can all be computed to help understand how well the chosen model works. To make it simpler to compare the different metrics, the below function created computes each of the aforementioned metrics through including the observed values and the predicted values as arguments.</p>
<div class="sourceCode" id="cb790"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb790-1"><a href="model-fit-checks-and-cross-validation.html#cb790-1" tabindex="-1"></a><span class="co">#create model metrics function</span></span>
<span id="cb790-2"><a href="model-fit-checks-and-cross-validation.html#cb790-2" tabindex="-1"></a>mod_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred){</span>
<span id="cb790-3"><a href="model-fit-checks-and-cross-validation.html#cb790-3" tabindex="-1"></a>  residual <span class="ot">=</span> pred <span class="sc">-</span> obs</span>
<span id="cb790-4"><a href="model-fit-checks-and-cross-validation.html#cb790-4" tabindex="-1"></a>  MAE <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">abs</span>(residual), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co">#Mean Absolute Error</span></span>
<span id="cb790-5"><a href="model-fit-checks-and-cross-validation.html#cb790-5" tabindex="-1"></a>  MSE <span class="ot">=</span> <span class="fu">mean</span>(residual<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co">#Mean Square Error</span></span>
<span id="cb790-6"><a href="model-fit-checks-and-cross-validation.html#cb790-6" tabindex="-1"></a>  RMSE <span class="ot">=</span> <span class="fu">sqrt</span>(MSE) <span class="co">#Root Mean Square Error </span></span>
<span id="cb790-7"><a href="model-fit-checks-and-cross-validation.html#cb790-7" tabindex="-1"></a>  BIAS <span class="ot">=</span> <span class="fu">mean</span>(residual, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co">#Bias</span></span>
<span id="cb790-8"><a href="model-fit-checks-and-cross-validation.html#cb790-8" tabindex="-1"></a>  CORR <span class="ot">=</span> <span class="fu">cor</span>(obs[<span class="sc">!</span><span class="fu">is.na</span>(obs)], pred[<span class="sc">!</span><span class="fu">is.na</span>(obs)]) <span class="co">#Correlation</span></span>
<span id="cb790-9"><a href="model-fit-checks-and-cross-validation.html#cb790-9" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">MAE  =</span> MAE ,</span>
<span id="cb790-10"><a href="model-fit-checks-and-cross-validation.html#cb790-10" tabindex="-1"></a>                 <span class="at">RMSE =</span> RMSE,</span>
<span id="cb790-11"><a href="model-fit-checks-and-cross-validation.html#cb790-11" tabindex="-1"></a>                 <span class="at">BIAS =</span> <span class="fu">abs</span>(BIAS),</span>
<span id="cb790-12"><a href="model-fit-checks-and-cross-validation.html#cb790-12" tabindex="-1"></a>                 <span class="at">CORR =</span> CORR)</span>
<span id="cb790-13"><a href="model-fit-checks-and-cross-validation.html#cb790-13" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb790-14"><a href="model-fit-checks-and-cross-validation.html#cb790-14" tabindex="-1"></a>}</span></code></pre></div>
<p>To begin with, the log-density can be included as the observed values with the manually predicted values from the chosen model also included as an argument.</p>
<div class="sourceCode" id="cb791"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb791-1"><a href="model-fit-checks-and-cross-validation.html#cb791-1" tabindex="-1"></a><span class="co">#compute the model metrics</span></span>
<span id="cb791-2"><a href="model-fit-checks-and-cross-validation.html#cb791-2" tabindex="-1"></a>metrics <span class="ot">&lt;-</span> <span class="fu">mod_metrics</span>(test_data<span class="sc">$</span>LDensity, pred_manual)</span>
<span id="cb791-3"><a href="model-fit-checks-and-cross-validation.html#cb791-3" tabindex="-1"></a></span>
<span id="cb791-4"><a href="model-fit-checks-and-cross-validation.html#cb791-4" tabindex="-1"></a><span class="co">#remove the list structure and round the results to 4 d.p.</span></span>
<span id="cb791-5"><a href="model-fit-checks-and-cross-validation.html#cb791-5" tabindex="-1"></a>met <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">unlist</span>(metrics), <span class="dv">4</span>) </span>
<span id="cb791-6"><a href="model-fit-checks-and-cross-validation.html#cb791-6" tabindex="-1"></a>met </span></code></pre></div>
<pre><code>##    MAE   RMSE   BIAS   CORR 
## 0.8507 1.1276 0.0938 0.5317</code></pre>
<p>The metrics results indicate the model works well. For example, the range of MAE is from 0 to <span class="math inline">\(\infty\)</span>, where a score of 0 would indicate that the resulting predictions are perfect, therefore a low value of 1.0116 is good. Similarly, the rest of the metrics are also small, particularly the bias and correlation, two values that you want to be as small as possible for a better fitting model.</p>
<p>Repeated cross-validation can be used to better assess the model metrics through obtaining average values for the metrics. This is done in the code below where the start values are set to be 0, following the same process as before through randomly splitting the data, modelling the training data and predicting with the test data followed by computing the metrics. The mean value can then be computed for each of the metrics and compared to the results obtained above for when the process is only completed once. The results from the repeated CV support the prior conclusions that the model chosen works well in the case of this data.</p>
<div class="sourceCode" id="cb793"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb793-1"><a href="model-fit-checks-and-cross-validation.html#cb793-1" tabindex="-1"></a><span class="co">#run the cross validation multiple number of times and average the values</span></span>
<span id="cb793-2"><a href="model-fit-checks-and-cross-validation.html#cb793-2" tabindex="-1"></a>MAE <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb793-3"><a href="model-fit-checks-and-cross-validation.html#cb793-3" tabindex="-1"></a>RMSE <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb793-4"><a href="model-fit-checks-and-cross-validation.html#cb793-4" tabindex="-1"></a>BIAS <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb793-5"><a href="model-fit-checks-and-cross-validation.html#cb793-5" tabindex="-1"></a>CORR <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb793-6"><a href="model-fit-checks-and-cross-validation.html#cb793-6" tabindex="-1"></a></span>
<span id="cb793-7"><a href="model-fit-checks-and-cross-validation.html#cb793-7" tabindex="-1"></a><span class="co">#choosing here to run the validation 20 times</span></span>
<span id="cb793-8"><a href="model-fit-checks-and-cross-validation.html#cb793-8" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>){</span>
<span id="cb793-9"><a href="model-fit-checks-and-cross-validation.html#cb793-9" tabindex="-1"></a>  <span class="co">#select the number of training samples to take to be 80% of the observations</span></span>
<span id="cb793-10"><a href="model-fit-checks-and-cross-validation.html#cb793-10" tabindex="-1"></a>  n_train <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(<span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(Data_CMR_std))</span>
<span id="cb793-11"><a href="model-fit-checks-and-cross-validation.html#cb793-11" tabindex="-1"></a>  <span class="co">#sample the the indices for the training data</span></span>
<span id="cb793-12"><a href="model-fit-checks-and-cross-validation.html#cb793-12" tabindex="-1"></a>  train_sample <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(Data_CMR_std)), n_train)</span>
<span id="cb793-13"><a href="model-fit-checks-and-cross-validation.html#cb793-13" tabindex="-1"></a>  <span class="co">#create the training dataset</span></span>
<span id="cb793-14"><a href="model-fit-checks-and-cross-validation.html#cb793-14" tabindex="-1"></a>  train_data <span class="ot">&lt;-</span> Data_CMR_std[train_sample, ]</span>
<span id="cb793-15"><a href="model-fit-checks-and-cross-validation.html#cb793-15" tabindex="-1"></a>  <span class="co">#create the test dataset to contain the remaining observations (20%)</span></span>
<span id="cb793-16"><a href="model-fit-checks-and-cross-validation.html#cb793-16" tabindex="-1"></a>  test_data <span class="ot">&lt;-</span> Data_CMR_std[<span class="sc">-</span>train_sample, ]</span>
<span id="cb793-17"><a href="model-fit-checks-and-cross-validation.html#cb793-17" tabindex="-1"></a>  </span>
<span id="cb793-18"><a href="model-fit-checks-and-cross-validation.html#cb793-18" tabindex="-1"></a>  <span class="co">#fit the training model using the previously selected covariates</span></span>
<span id="cb793-19"><a href="model-fit-checks-and-cross-validation.html#cb793-19" tabindex="-1"></a>  train_model <span class="ot">&lt;-</span>  <span class="fu">glm</span>(<span class="at">formula =</span> y <span class="sc">~</span> x2 <span class="sc">+</span> x16 <span class="sc">+</span> x20 <span class="sc">+</span> x24 <span class="sc">+</span> x31 <span class="sc">+</span> x36 <span class="sc">+</span> x40, </span>
<span id="cb793-20"><a href="model-fit-checks-and-cross-validation.html#cb793-20" tabindex="-1"></a>             <span class="at">family =</span> gaussian, <span class="at">data =</span> train_data)</span>
<span id="cb793-21"><a href="model-fit-checks-and-cross-validation.html#cb793-21" tabindex="-1"></a>  </span>
<span id="cb793-22"><a href="model-fit-checks-and-cross-validation.html#cb793-22" tabindex="-1"></a>  <span class="co">#save the coefficients from the training model</span></span>
<span id="cb793-23"><a href="model-fit-checks-and-cross-validation.html#cb793-23" tabindex="-1"></a>  coeffs <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(train_model)</span>
<span id="cb793-24"><a href="model-fit-checks-and-cross-validation.html#cb793-24" tabindex="-1"></a>  <span class="co">#manually predict using the model coefficients</span></span>
<span id="cb793-25"><a href="model-fit-checks-and-cross-validation.html#cb793-25" tabindex="-1"></a>  pred_manual <span class="ot">&lt;-</span>  coeffs[<span class="dv">1</span>] <span class="sc">+</span> coeffs[<span class="dv">2</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x2 <span class="sc">+</span> coeffs[<span class="dv">3</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x16 <span class="sc">+</span></span>
<span id="cb793-26"><a href="model-fit-checks-and-cross-validation.html#cb793-26" tabindex="-1"></a>    coeffs[<span class="dv">4</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x20 <span class="sc">+</span> coeffs[<span class="dv">5</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x24 <span class="sc">+</span></span>
<span id="cb793-27"><a href="model-fit-checks-and-cross-validation.html#cb793-27" tabindex="-1"></a>    coeffs[<span class="dv">6</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x31 <span class="sc">+</span> coeffs[<span class="dv">7</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x36 <span class="sc">+</span> coeffs[<span class="dv">8</span>]<span class="sc">*</span>test_data<span class="sc">$</span>x40</span>
<span id="cb793-28"><a href="model-fit-checks-and-cross-validation.html#cb793-28" tabindex="-1"></a></span>
<span id="cb793-29"><a href="model-fit-checks-and-cross-validation.html#cb793-29" tabindex="-1"></a>  <span class="co">#obtain the metrics for the model using the model metrics function</span></span>
<span id="cb793-30"><a href="model-fit-checks-and-cross-validation.html#cb793-30" tabindex="-1"></a>  metrics <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">unlist</span>(<span class="fu">mod_metrics</span>(test_data<span class="sc">$</span>LDensity, pred_manual)),<span class="dv">4</span>)</span>
<span id="cb793-31"><a href="model-fit-checks-and-cross-validation.html#cb793-31" tabindex="-1"></a></span>
<span id="cb793-32"><a href="model-fit-checks-and-cross-validation.html#cb793-32" tabindex="-1"></a>  <span class="co">#extract each of the metrics for the model and sum to result from </span></span>
<span id="cb793-33"><a href="model-fit-checks-and-cross-validation.html#cb793-33" tabindex="-1"></a>  <span class="co">#previous iteration to find mean metric value later</span></span>
<span id="cb793-34"><a href="model-fit-checks-and-cross-validation.html#cb793-34" tabindex="-1"></a>  MAE  <span class="ot">&lt;-</span> MAE <span class="sc">+</span> metrics[<span class="dv">1</span>]</span>
<span id="cb793-35"><a href="model-fit-checks-and-cross-validation.html#cb793-35" tabindex="-1"></a>  RMSE <span class="ot">&lt;-</span> RMSE <span class="sc">+</span> metrics[<span class="dv">2</span>]</span>
<span id="cb793-36"><a href="model-fit-checks-and-cross-validation.html#cb793-36" tabindex="-1"></a>  MAE <span class="ot">&lt;-</span> MAE <span class="sc">+</span> metrics[<span class="dv">3</span>]</span>
<span id="cb793-37"><a href="model-fit-checks-and-cross-validation.html#cb793-37" tabindex="-1"></a>  CORR <span class="ot">&lt;-</span> CORR <span class="sc">+</span> metrics[<span class="dv">4</span>]</span>
<span id="cb793-38"><a href="model-fit-checks-and-cross-validation.html#cb793-38" tabindex="-1"></a>}</span>
<span id="cb793-39"><a href="model-fit-checks-and-cross-validation.html#cb793-39" tabindex="-1"></a><span class="co">#create a data frame for the model metrics, averaged across the 20 iterations</span></span>
<span id="cb793-40"><a href="model-fit-checks-and-cross-validation.html#cb793-40" tabindex="-1"></a>av_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">MAE =</span> MAE<span class="sc">/</span><span class="dv">20</span>,</span>
<span id="cb793-41"><a href="model-fit-checks-and-cross-validation.html#cb793-41" tabindex="-1"></a>                <span class="at">RMSE =</span> RMSE<span class="sc">/</span><span class="dv">20</span>,</span>
<span id="cb793-42"><a href="model-fit-checks-and-cross-validation.html#cb793-42" tabindex="-1"></a>                <span class="at">BIAS =</span> BIAS<span class="sc">/</span><span class="dv">20</span>,</span>
<span id="cb793-43"><a href="model-fit-checks-and-cross-validation.html#cb793-43" tabindex="-1"></a>                <span class="at">CORR =</span> CORR<span class="sc">/</span><span class="dv">20</span>)</span>
<span id="cb793-44"><a href="model-fit-checks-and-cross-validation.html#cb793-44" tabindex="-1"></a></span>
<span id="cb793-45"><a href="model-fit-checks-and-cross-validation.html#cb793-45" tabindex="-1"></a><span class="co">#print the result</span></span>
<span id="cb793-46"><a href="model-fit-checks-and-cross-validation.html#cb793-46" tabindex="-1"></a>(met_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(met, av_metrics)) <span class="co">#include in brackets to print result</span></span></code></pre></div>
<pre><code>##          MAE     RMSE   BIAS    CORR
## 1   0.850700 1.127600 0.0938 0.53170
## MAE 0.909175 1.206045 0.0000 0.48217</code></pre>
</div>
<div id="k-fold-cross-validation-1" class="section level3 hasAnchor" number="9.3.2">
<h3><span class="header-section-number">9.3.2</span> K-Fold Cross-Validation<a href="model-fit-checks-and-cross-validation.html#k-fold-cross-validation-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>K-fold cross-validation is a common choice of method for cross-validation for multiple reasons. Firstly, it is particularly useful in the case where the number of samples available is small given that this approach does not waste much data. Additionally, in comparison to alternative cross-validation approaches, k-fold cross-validation often results in models with less bias as it ensures that each data point is used for both training and validation. Therefore, this approach ensures that each of the observations from the original dataset are able to appear in both the training and test datasets. In this section, to demonstrate the process of k-fold cross-validation, both <strong>in-sample</strong> (data from the sample is used to develop the model that is used for the predictions) and <strong>out-of-sample</strong> (data that wasn’t used in the development of the model is used for the predictions), a function is created which allows for an automated process of the cross-validation.</p>
<p>Firstly, a function to compute the model metrics must be created, this takes the observed and predicted values and computes the mean absolute error, mean square error, root mean square error, bias and the correlation coefficient. This function will aid in streamlining the cross-validation function.</p>
<div class="sourceCode" id="cb795"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb795-1"><a href="model-fit-checks-and-cross-validation.html#cb795-1" tabindex="-1"></a><span class="co">#create model metrics function</span></span>
<span id="cb795-2"><a href="model-fit-checks-and-cross-validation.html#cb795-2" tabindex="-1"></a>model_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred){</span>
<span id="cb795-3"><a href="model-fit-checks-and-cross-validation.html#cb795-3" tabindex="-1"></a>  residual <span class="ot">=</span> pred <span class="sc">-</span> obs</span>
<span id="cb795-4"><a href="model-fit-checks-and-cross-validation.html#cb795-4" tabindex="-1"></a>  MAE <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">abs</span>(residual), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co">#Mean Absolute Error</span></span>
<span id="cb795-5"><a href="model-fit-checks-and-cross-validation.html#cb795-5" tabindex="-1"></a>  MSE <span class="ot">=</span> <span class="fu">mean</span>(residual<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co">#Mean Square Error</span></span>
<span id="cb795-6"><a href="model-fit-checks-and-cross-validation.html#cb795-6" tabindex="-1"></a>  RMSE <span class="ot">=</span> <span class="fu">sqrt</span>(MSE) <span class="co">#Root Mean Square Error</span></span>
<span id="cb795-7"><a href="model-fit-checks-and-cross-validation.html#cb795-7" tabindex="-1"></a>  BIAS <span class="ot">=</span> <span class="fu">mean</span>(residual, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co">#Bias</span></span>
<span id="cb795-8"><a href="model-fit-checks-and-cross-validation.html#cb795-8" tabindex="-1"></a>  CORR <span class="ot">=</span> <span class="fu">cor</span>(obs[<span class="sc">!</span><span class="fu">is.na</span>(obs)], pred[<span class="sc">!</span><span class="fu">is.na</span>(obs)]) <span class="co">#Correlation Coefficient</span></span>
<span id="cb795-9"><a href="model-fit-checks-and-cross-validation.html#cb795-9" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">MAE  =</span> MAE,</span>
<span id="cb795-10"><a href="model-fit-checks-and-cross-validation.html#cb795-10" tabindex="-1"></a>                 <span class="at">RMSE =</span> RMSE,</span>
<span id="cb795-11"><a href="model-fit-checks-and-cross-validation.html#cb795-11" tabindex="-1"></a>                 <span class="at">BIAS =</span> <span class="fu">abs</span>(BIAS),</span>
<span id="cb795-12"><a href="model-fit-checks-and-cross-validation.html#cb795-12" tabindex="-1"></a>                 <span class="at">CC =</span> CORR)</span>
<span id="cb795-13"><a href="model-fit-checks-and-cross-validation.html#cb795-13" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb795-14"><a href="model-fit-checks-and-cross-validation.html#cb795-14" tabindex="-1"></a>}</span></code></pre></div>
<!-- Then, a function to extract the different settlement types from the data is created. These two functions allow for the cross-validation function to be more streamlined. -->
<!-- ```{r settlement types function} -->
<!-- #extract settlement types function -->
<!-- settle_type <- function(dat, st) -->
<!-- { -->
<!--   uniq <- unique(dat$set_typ) -->
<!--   uniq[1] -->
<!--   for(i in  1:nrow(dat)) -->
<!--   { -->
<!--     for(j in 1:3) -->
<!--     { -->
<!--       if(dat$set_typ[i]==uniq[j]) dat$set_typ2[i] = st[j] -->
<!--     } -->
<!--   } -->
<!--   dat$set_typ2 -->
<!-- } -->
<!-- ``` -->
<p>Then, the function for the k-fold cross-validation can be created. For alternative datasets, the selected covariates should be changed to suit your data.</p>
<p>The arguments needed for the function are as follows.</p>
<ul>
<li><code>dat</code>: the input survey data containing all the variables</li>
<li><code>n.folds</code>: the number of test (k) folds to use</li>
<li><code>mod</code>: the best model of the full or reference data</li>
<li><code>A</code>: the projection matrix used in training the full data model</li>
<li><code>cov</code>: the fixed covariates from the selected model</li>
<li><code>cov2</code>: additional covariates to use in the out-of-sample training stack</li>
<li><code>seed</code>: a random sample seed used to make the results reproducible</li>
</ul>
<div class="sourceCode" id="cb796"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb796-1"><a href="model-fit-checks-and-cross-validation.html#cb796-1" tabindex="-1"></a>cross_validate <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, n.folds, mod, form, A, cov, cov2, seed){</span>
<span id="cb796-2"><a href="model-fit-checks-and-cross-validation.html#cb796-2" tabindex="-1"></a></span>
<span id="cb796-3"><a href="model-fit-checks-and-cross-validation.html#cb796-3" tabindex="-1"></a>  <span class="co">#set the seed for reproducibility</span></span>
<span id="cb796-4"><a href="model-fit-checks-and-cross-validation.html#cb796-4" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed) </span>
<span id="cb796-5"><a href="model-fit-checks-and-cross-validation.html#cb796-5" tabindex="-1"></a>  <span class="co">#number of rows in the dataset</span></span>
<span id="cb796-6"><a href="model-fit-checks-and-cross-validation.html#cb796-6" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dat) </span>
<span id="cb796-7"><a href="model-fit-checks-and-cross-validation.html#cb796-7" tabindex="-1"></a>  </span>
<span id="cb796-8"><a href="model-fit-checks-and-cross-validation.html#cb796-8" tabindex="-1"></a>  <span class="co">#sample IDs for the training data</span></span>
<span id="cb796-9"><a href="model-fit-checks-and-cross-validation.html#cb796-9" tabindex="-1"></a>  <span class="fu">table</span>(ind_train <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sample</span>(<span class="at">x =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n.folds, </span>
<span id="cb796-10"><a href="model-fit-checks-and-cross-validation.html#cb796-10" tabindex="-1"></a>                                           <span class="at">each =</span> <span class="fu">floor</span>(N <span class="sc">/</span> n.folds)),  </span>
<span id="cb796-11"><a href="model-fit-checks-and-cross-validation.html#cb796-11" tabindex="-1"></a>                                   <span class="at">size =</span> N)))</span>
<span id="cb796-12"><a href="model-fit-checks-and-cross-validation.html#cb796-12" tabindex="-1"></a>  </span>
<span id="cb796-13"><a href="model-fit-checks-and-cross-validation.html#cb796-13" tabindex="-1"></a>  <span class="co">#create a table for the training IDs</span></span>
<span id="cb796-14"><a href="model-fit-checks-and-cross-validation.html#cb796-14" tabindex="-1"></a>  <span class="fu">table</span>(<span class="fu">as.numeric</span>(ind_train)) </span>
<span id="cb796-15"><a href="model-fit-checks-and-cross-validation.html#cb796-15" tabindex="-1"></a>  dat<span class="sc">$</span>k_fold <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(ind_train)</span>
<span id="cb796-16"><a href="model-fit-checks-and-cross-validation.html#cb796-16" tabindex="-1"></a>  </span>
<span id="cb796-17"><a href="model-fit-checks-and-cross-validation.html#cb796-17" tabindex="-1"></a>  <span class="co">#vector for the longitude and latitude coordinates</span></span>
<span id="cb796-18"><a href="model-fit-checks-and-cross-validation.html#cb796-18" tabindex="-1"></a>  coords <span class="ot">&lt;-</span> <span class="fu">cbind</span>(dat<span class="sc">$</span>lon, dat<span class="sc">$</span>lat)</span>
<span id="cb796-19"><a href="model-fit-checks-and-cross-validation.html#cb796-19" tabindex="-1"></a>  <span class="co">#sort the unique folds</span></span>
<span id="cb796-20"><a href="model-fit-checks-and-cross-validation.html#cb796-20" tabindex="-1"></a>  k_uniq <span class="ot">&lt;-</span><span class="fu">sort</span>(<span class="fu">unique</span>(dat<span class="sc">$</span>k_fold))</span>
<span id="cb796-21"><a href="model-fit-checks-and-cross-validation.html#cb796-21" tabindex="-1"></a>  </span>
<span id="cb796-22"><a href="model-fit-checks-and-cross-validation.html#cb796-22" tabindex="-1"></a>  </span>
<span id="cb796-23"><a href="model-fit-checks-and-cross-validation.html#cb796-23" tabindex="-1"></a>  <span class="co">#--------------------------------------------------------------------------#</span></span>
<span id="cb796-24"><a href="model-fit-checks-and-cross-validation.html#cb796-24" tabindex="-1"></a>  <span class="co">#                                 In-Sample                                #</span></span>
<span id="cb796-25"><a href="model-fit-checks-and-cross-validation.html#cb796-25" tabindex="-1"></a>  <span class="co">#--------------------------------------------------------------------------#</span></span>
<span id="cb796-26"><a href="model-fit-checks-and-cross-validation.html#cb796-26" tabindex="-1"></a>  </span>
<span id="cb796-27"><a href="model-fit-checks-and-cross-validation.html#cb796-27" tabindex="-1"></a>  <span class="co">#create variables for the metrics and predictions</span></span>
<span id="cb796-28"><a href="model-fit-checks-and-cross-validation.html#cb796-28" tabindex="-1"></a>  met_list_in <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb796-29"><a href="model-fit-checks-and-cross-validation.html#cb796-29" tabindex="-1"></a>  pred_list_in <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb796-30"><a href="model-fit-checks-and-cross-validation.html#cb796-30" tabindex="-1"></a>  </span>
<span id="cb796-31"><a href="model-fit-checks-and-cross-validation.html#cb796-31" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(k_uniq)){ <span class="co">#cycle through each of the unique folds</span></span>
<span id="cb796-32"><a href="model-fit-checks-and-cross-validation.html#cb796-32" tabindex="-1"></a>    <span class="co">#keep track the current fold</span></span>
<span id="cb796-33"><a href="model-fit-checks-and-cross-validation.html#cb796-33" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;in-sample cross-validation using fold &quot;</span>, i, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb796-34"><a href="model-fit-checks-and-cross-validation.html#cb796-34" tabindex="-1"></a>    <span class="co">#select the test data for fold i</span></span>
<span id="cb796-35"><a href="model-fit-checks-and-cross-validation.html#cb796-35" tabindex="-1"></a>    test_ind <span class="ot">&lt;-</span> <span class="fu">which</span>(dat<span class="sc">$</span>k_fold <span class="sc">==</span> k_uniq[i])</span>
<span id="cb796-36"><a href="model-fit-checks-and-cross-validation.html#cb796-36" tabindex="-1"></a>    <span class="fu">dim</span>(test <span class="ot">&lt;-</span> dat[test_ind, ])</span>
<span id="cb796-37"><a href="model-fit-checks-and-cross-validation.html#cb796-37" tabindex="-1"></a>    <span class="co">#train and test data coordinates</span></span>
<span id="cb796-38"><a href="model-fit-checks-and-cross-validation.html#cb796-38" tabindex="-1"></a>    train_coords <span class="ot">&lt;-</span> coords</span>
<span id="cb796-39"><a href="model-fit-checks-and-cross-validation.html#cb796-39" tabindex="-1"></a>    test_coords <span class="ot">&lt;-</span> coords[test_ind,]</span>
<span id="cb796-40"><a href="model-fit-checks-and-cross-validation.html#cb796-40" tabindex="-1"></a>    </span>
<span id="cb796-41"><a href="model-fit-checks-and-cross-validation.html#cb796-41" tabindex="-1"></a>    <span class="co">#spatial random effects based on the full data best model</span></span>
<span id="cb796-42"><a href="model-fit-checks-and-cross-validation.html#cb796-42" tabindex="-1"></a>    sfield_nodes_mean <span class="ot">&lt;-</span> mod<span class="sc">$</span>summary.random<span class="sc">$</span>spatial.field[<span class="st">&#39;mean&#39;</span>]</span>
<span id="cb796-43"><a href="model-fit-checks-and-cross-validation.html#cb796-43" tabindex="-1"></a>    field_mean <span class="ot">&lt;-</span> (A<span class="sc">%*%</span> <span class="fu">as.data.frame</span>(sfield_nodes_mean)[, <span class="dv">1</span>])</span>
<span id="cb796-44"><a href="model-fit-checks-and-cross-validation.html#cb796-44" tabindex="-1"></a>    </span>
<span id="cb796-45"><a href="model-fit-checks-and-cross-validation.html#cb796-45" tabindex="-1"></a>    <span class="co">#list of selected covariates</span></span>
<span id="cb796-46"><a href="model-fit-checks-and-cross-validation.html#cb796-46" tabindex="-1"></a>    fixed <span class="ot">&lt;-</span> mod<span class="sc">$</span>summary.fixed[<span class="st">&#39;Intercept&#39;</span>, <span class="st">&#39;mean&#39;</span>] <span class="co">#fixed effects</span></span>
<span id="cb796-47"><a href="model-fit-checks-and-cross-validation.html#cb796-47" tabindex="-1"></a>    <span class="cf">for</span>(covariate <span class="cf">in</span> cov){</span>
<span id="cb796-48"><a href="model-fit-checks-and-cross-validation.html#cb796-48" tabindex="-1"></a>      fixed <span class="ot">&lt;-</span> fixed <span class="sc">+</span> mod<span class="sc">$</span>summary.fixed[<span class="fu">paste0</span>(covariate), <span class="st">&#39;mean&#39;</span>] <span class="sc">*</span></span>
<span id="cb796-49"><a href="model-fit-checks-and-cross-validation.html#cb796-49" tabindex="-1"></a>        test[,<span class="fu">paste0</span>(covariate)]</span>
<span id="cb796-50"><a href="model-fit-checks-and-cross-validation.html#cb796-50" tabindex="-1"></a>    }</span>
<span id="cb796-51"><a href="model-fit-checks-and-cross-validation.html#cb796-51" tabindex="-1"></a>    <span class="co">#add settlement type and region nested effects</span></span>
<span id="cb796-52"><a href="model-fit-checks-and-cross-validation.html#cb796-52" tabindex="-1"></a>    fixed <span class="ot">=</span> fixed <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(test), <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>mod<span class="sc">$</span>summary.hyperpar<span class="sc">$</span>mean[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb796-53"><a href="model-fit-checks-and-cross-validation.html#cb796-53" tabindex="-1"></a>    <span class="co">#add settlement type random effect</span></span>
<span id="cb796-54"><a href="model-fit-checks-and-cross-validation.html#cb796-54" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="fu">nrow</span>(test), <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>mod<span class="sc">$</span>summary.hyperpar<span class="sc">$</span>mean[<span class="dv">5</span>]) <span class="sc">+</span> </span>
<span id="cb796-55"><a href="model-fit-checks-and-cross-validation.html#cb796-55" tabindex="-1"></a>      <span class="co">#add uncorrelated spatial random effects</span></span>
<span id="cb796-56"><a href="model-fit-checks-and-cross-validation.html#cb796-56" tabindex="-1"></a>      mod<span class="sc">$</span>summary.random<span class="sc">$</span>IDsr[<span class="st">&#39;mean&#39;</span>][test_ind,<span class="dv">1</span>] <span class="sc">+</span> field_mean[test_ind,<span class="dv">1</span>]</span>
<span id="cb796-57"><a href="model-fit-checks-and-cross-validation.html#cb796-57" tabindex="-1"></a>    </span>
<span id="cb796-58"><a href="model-fit-checks-and-cross-validation.html#cb796-58" tabindex="-1"></a>    dens_ht <span class="ot">&lt;-</span> <span class="fu">exp</span>(fixed)</span>
<span id="cb796-59"><a href="model-fit-checks-and-cross-validation.html#cb796-59" tabindex="-1"></a>    <span class="fu">sum</span>(pop_ht <span class="ot">&lt;-</span> dens_ht<span class="sc">*</span>test<span class="sc">$</span>bld)</span>
<span id="cb796-60"><a href="model-fit-checks-and-cross-validation.html#cb796-60" tabindex="-1"></a>    </span>
<span id="cb796-61"><a href="model-fit-checks-and-cross-validation.html#cb796-61" tabindex="-1"></a>    <span class="co">#scatter plots for each fold, uncomment for plots to show</span></span>
<span id="cb796-62"><a href="model-fit-checks-and-cross-validation.html#cb796-62" tabindex="-1"></a>    <span class="co"># par(mfrow = c(1,1))</span></span>
<span id="cb796-63"><a href="model-fit-checks-and-cross-validation.html#cb796-63" tabindex="-1"></a>    <span class="co"># plot(test$obs, pop_ht, xlab = &quot;Observed&quot;, </span></span>
<span id="cb796-64"><a href="model-fit-checks-and-cross-validation.html#cb796-64" tabindex="-1"></a>    <span class="co">#      ylab = &quot;Predicted&quot;, col = c(&#39;blue&#39;,&#39;orange&#39;),</span></span>
<span id="cb796-65"><a href="model-fit-checks-and-cross-validation.html#cb796-65" tabindex="-1"></a>    <span class="co">#      pch = c(16,16), cex.axis = 1.5)</span></span>
<span id="cb796-66"><a href="model-fit-checks-and-cross-validation.html#cb796-66" tabindex="-1"></a>    <span class="co"># abline(0,1)</span></span>
<span id="cb796-67"><a href="model-fit-checks-and-cross-validation.html#cb796-67" tabindex="-1"></a>    <span class="co"># legend(&quot;topleft&quot;, c(&quot;Observed&quot;, &quot;Predicted&quot;), col = c(&quot;blue&quot;, &quot;orange&quot;), </span></span>
<span id="cb796-68"><a href="model-fit-checks-and-cross-validation.html#cb796-68" tabindex="-1"></a>    <span class="co">#        pch = c(16,16), bty = &quot;n&quot;, cex = 1.5) </span></span>
<span id="cb796-69"><a href="model-fit-checks-and-cross-validation.html#cb796-69" tabindex="-1"></a>    </span>
<span id="cb796-70"><a href="model-fit-checks-and-cross-validation.html#cb796-70" tabindex="-1"></a>    <span class="co">#calculate fit metrics</span></span>
<span id="cb796-71"><a href="model-fit-checks-and-cross-validation.html#cb796-71" tabindex="-1"></a>    met_in <span class="ot">&lt;-</span> <span class="fu">model_metrics</span>(test<span class="sc">$</span>pop, pop_ht)</span>
<span id="cb796-72"><a href="model-fit-checks-and-cross-validation.html#cb796-72" tabindex="-1"></a>    </span>
<span id="cb796-73"><a href="model-fit-checks-and-cross-validation.html#cb796-73" tabindex="-1"></a>    met_list_in[[i]]<span class="ot">&lt;-</span> <span class="fu">unlist</span>(met_in)</span>
<span id="cb796-74"><a href="model-fit-checks-and-cross-validation.html#cb796-74" tabindex="-1"></a>    pred_list_in[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">obs =</span> test<span class="sc">$</span>obs, <span class="at">pred =</span> pop_ht,</span>
<span id="cb796-75"><a href="model-fit-checks-and-cross-validation.html#cb796-75" tabindex="-1"></a>                                    <span class="at">fold =</span> <span class="fu">rep</span>(i, <span class="fu">length</span>(test<span class="sc">$</span>obs)),</span>
<span id="cb796-76"><a href="model-fit-checks-and-cross-validation.html#cb796-76" tabindex="-1"></a>                                    <span class="at">data =</span> <span class="fu">rep</span>(<span class="st">&quot;insample&quot;</span>, <span class="fu">length</span>(test<span class="sc">$</span>obs)))</span>
<span id="cb796-77"><a href="model-fit-checks-and-cross-validation.html#cb796-77" tabindex="-1"></a>  }</span>
<span id="cb796-78"><a href="model-fit-checks-and-cross-validation.html#cb796-78" tabindex="-1"></a>  </span>
<span id="cb796-79"><a href="model-fit-checks-and-cross-validation.html#cb796-79" tabindex="-1"></a>  met_list_in_dat <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind,met_list_in)</span>
<span id="cb796-80"><a href="model-fit-checks-and-cross-validation.html#cb796-80" tabindex="-1"></a>  </span>
<span id="cb796-81"><a href="model-fit-checks-and-cross-validation.html#cb796-81" tabindex="-1"></a>  <span class="co">#fit metrics</span></span>
<span id="cb796-82"><a href="model-fit-checks-and-cross-validation.html#cb796-82" tabindex="-1"></a>  metrics_in <span class="ot">&lt;-</span> <span class="fu">apply</span>(met_list_in_dat, <span class="dv">2</span>, mean)</span>
<span id="cb796-83"><a href="model-fit-checks-and-cross-validation.html#cb796-83" tabindex="-1"></a>  </span>
<span id="cb796-84"><a href="model-fit-checks-and-cross-validation.html#cb796-84" tabindex="-1"></a>  <span class="co">#predictions</span></span>
<span id="cb796-85"><a href="model-fit-checks-and-cross-validation.html#cb796-85" tabindex="-1"></a>  pred_list_in_dat <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind,pred_list_in)</span>
<span id="cb796-86"><a href="model-fit-checks-and-cross-validation.html#cb796-86" tabindex="-1"></a>  </span>
<span id="cb796-87"><a href="model-fit-checks-and-cross-validation.html#cb796-87" tabindex="-1"></a>  <span class="co">#--------------------------------------------------------------------------#</span></span>
<span id="cb796-88"><a href="model-fit-checks-and-cross-validation.html#cb796-88" tabindex="-1"></a>  <span class="co">#                               Out-of-Sample                              #</span></span>
<span id="cb796-89"><a href="model-fit-checks-and-cross-validation.html#cb796-89" tabindex="-1"></a>  <span class="co">#--------------------------------------------------------------------------#</span></span>
<span id="cb796-90"><a href="model-fit-checks-and-cross-validation.html#cb796-90" tabindex="-1"></a>  </span>
<span id="cb796-91"><a href="model-fit-checks-and-cross-validation.html#cb796-91" tabindex="-1"></a>  <span class="co">#create variables for the model metrics and predictions</span></span>
<span id="cb796-92"><a href="model-fit-checks-and-cross-validation.html#cb796-92" tabindex="-1"></a>  met_list_out <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb796-93"><a href="model-fit-checks-and-cross-validation.html#cb796-93" tabindex="-1"></a>  pred_list_out <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb796-94"><a href="model-fit-checks-and-cross-validation.html#cb796-94" tabindex="-1"></a>  </span>
<span id="cb796-95"><a href="model-fit-checks-and-cross-validation.html#cb796-95" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(k_uniq)){<span class="co">#cycle through each of the unique folds</span></span>
<span id="cb796-96"><a href="model-fit-checks-and-cross-validation.html#cb796-96" tabindex="-1"></a>    <span class="co">#keep track of current fold</span></span>
<span id="cb796-97"><a href="model-fit-checks-and-cross-validation.html#cb796-97" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;out-of-sample cross-validation using fold &quot;</span>, i, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb796-98"><a href="model-fit-checks-and-cross-validation.html#cb796-98" tabindex="-1"></a>    <span class="co">#select the train and test data for fold i</span></span>
<span id="cb796-99"><a href="model-fit-checks-and-cross-validation.html#cb796-99" tabindex="-1"></a>    train_ind <span class="ot">&lt;-</span> <span class="fu">which</span>(dat<span class="sc">$</span>k_fold <span class="sc">!=</span> k_uniq[i])</span>
<span id="cb796-100"><a href="model-fit-checks-and-cross-validation.html#cb796-100" tabindex="-1"></a>    test_ind <span class="ot">&lt;-</span> <span class="fu">which</span>(dat<span class="sc">$</span>k_fold <span class="sc">==</span> k_uniq[i])</span>
<span id="cb796-101"><a href="model-fit-checks-and-cross-validation.html#cb796-101" tabindex="-1"></a>    <span class="fu">dim</span>(train <span class="ot">&lt;-</span> dat[train_ind, ])</span>
<span id="cb796-102"><a href="model-fit-checks-and-cross-validation.html#cb796-102" tabindex="-1"></a>    <span class="fu">dim</span>(test <span class="ot">&lt;-</span> dat[test_ind, ])</span>
<span id="cb796-103"><a href="model-fit-checks-and-cross-validation.html#cb796-103" tabindex="-1"></a>    <span class="co">#train and test data coordinates</span></span>
<span id="cb796-104"><a href="model-fit-checks-and-cross-validation.html#cb796-104" tabindex="-1"></a>    train_coords <span class="ot">&lt;-</span> coords[train_ind,]</span>
<span id="cb796-105"><a href="model-fit-checks-and-cross-validation.html#cb796-105" tabindex="-1"></a>    test_coords <span class="ot">&lt;-</span> coords[test_ind,]</span>
<span id="cb796-106"><a href="model-fit-checks-and-cross-validation.html#cb796-106" tabindex="-1"></a>    </span>
<span id="cb796-107"><a href="model-fit-checks-and-cross-validation.html#cb796-107" tabindex="-1"></a>    <span class="co">#create a projection matrix for training data</span></span>
<span id="cb796-108"><a href="model-fit-checks-and-cross-validation.html#cb796-108" tabindex="-1"></a>    Ae<span class="ot">&lt;-</span><span class="fu">inla.spde.make.A</span>(<span class="at">mesh =</span> mesh,<span class="at">loc =</span> <span class="fu">as.matrix</span>(train_coords)); <span class="fu">dim</span>(Ae) </span>
<span id="cb796-109"><a href="model-fit-checks-and-cross-validation.html#cb796-109" tabindex="-1"></a>    covars_train <span class="ot">&lt;-</span> train[,<span class="fu">c</span>(cov, cov2)]</span>
<span id="cb796-110"><a href="model-fit-checks-and-cross-validation.html#cb796-110" tabindex="-1"></a>    stk_train <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> train<span class="sc">$</span>dens), <span class="co">#the response</span></span>
<span id="cb796-111"><a href="model-fit-checks-and-cross-validation.html#cb796-111" tabindex="-1"></a>                            <span class="at">A =</span> <span class="fu">list</span>(Ae,<span class="dv">1</span>),  <span class="co">#the A matrix</span></span>
<span id="cb796-112"><a href="model-fit-checks-and-cross-validation.html#cb796-112" tabindex="-1"></a>                            <span class="at">effects =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="fu">list</span>(<span class="at">Intercept =</span> <span class="dv">1</span>), <span class="co">#the Intercept</span></span>
<span id="cb796-113"><a href="model-fit-checks-and-cross-validation.html#cb796-113" tabindex="-1"></a>                                           iset),  <span class="co">#the spatial index</span></span>
<span id="cb796-114"><a href="model-fit-checks-and-cross-validation.html#cb796-114" tabindex="-1"></a>                                         <span class="fu">list</span>(covars_train)), <span class="co">#the covariates</span></span>
<span id="cb796-115"><a href="model-fit-checks-and-cross-validation.html#cb796-115" tabindex="-1"></a>                            <span class="at">tag =</span> <span class="st">&#39;train&#39;</span>)</span>
<span id="cb796-116"><a href="model-fit-checks-and-cross-validation.html#cb796-116" tabindex="-1"></a>    </span>
<span id="cb796-117"><a href="model-fit-checks-and-cross-validation.html#cb796-117" tabindex="-1"></a>    </span>
<span id="cb796-118"><a href="model-fit-checks-and-cross-validation.html#cb796-118" tabindex="-1"></a>    model <span class="ot">&lt;-</span><span class="fu">inla</span>(form, <span class="co">#the formula</span></span>
<span id="cb796-119"><a href="model-fit-checks-and-cross-validation.html#cb796-119" tabindex="-1"></a>                 <span class="at">data =</span> <span class="fu">inla.stack.data</span>(stk_train,<span class="at">spde =</span> spde),  </span>
<span id="cb796-120"><a href="model-fit-checks-and-cross-validation.html#cb796-120" tabindex="-1"></a>                 <span class="at">family =</span> <span class="st">&#39;gamma&#39;</span>,   </span>
<span id="cb796-121"><a href="model-fit-checks-and-cross-validation.html#cb796-121" tabindex="-1"></a>                 <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">A =</span> <span class="fu">inla.stack.A</span>(stk_train),</span>
<span id="cb796-122"><a href="model-fit-checks-and-cross-validation.html#cb796-122" tabindex="-1"></a>                                        <span class="at">compute =</span> <span class="cn">TRUE</span>), </span>
<span id="cb796-123"><a href="model-fit-checks-and-cross-validation.html#cb796-123" tabindex="-1"></a>                 <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> <span class="cn">TRUE</span>, <span class="at">waic =</span> <span class="cn">TRUE</span>, <span class="at">cpo =</span> <span class="cn">TRUE</span>, </span>
<span id="cb796-124"><a href="model-fit-checks-and-cross-validation.html#cb796-124" tabindex="-1"></a>                                        <span class="at">config =</span> <span class="cn">TRUE</span>),</span>
<span id="cb796-125"><a href="model-fit-checks-and-cross-validation.html#cb796-125" tabindex="-1"></a>                 <span class="at">verbose =</span> <span class="cn">FALSE</span>) </span>
<span id="cb796-126"><a href="model-fit-checks-and-cross-validation.html#cb796-126" tabindex="-1"></a>    <span class="fu">summary</span>(model)</span>
<span id="cb796-127"><a href="model-fit-checks-and-cross-validation.html#cb796-127" tabindex="-1"></a>    </span>
<span id="cb796-128"><a href="model-fit-checks-and-cross-validation.html#cb796-128" tabindex="-1"></a>    <span class="co">#extract spatial random effects from the full data best model</span></span>
<span id="cb796-129"><a href="model-fit-checks-and-cross-validation.html#cb796-129" tabindex="-1"></a>    sfield_nodes_mean <span class="ot">&lt;-</span> mod<span class="sc">$</span>summary.random<span class="sc">$</span>spatial.field[<span class="st">&#39;mean&#39;</span>]</span>
<span id="cb796-130"><a href="model-fit-checks-and-cross-validation.html#cb796-130" tabindex="-1"></a>    field_mean <span class="ot">&lt;-</span> (A<span class="sc">%*%</span> <span class="fu">as.data.frame</span>(sfield_nodes_mean)[, <span class="dv">1</span>])</span>
<span id="cb796-131"><a href="model-fit-checks-and-cross-validation.html#cb796-131" tabindex="-1"></a>    </span>
<span id="cb796-132"><a href="model-fit-checks-and-cross-validation.html#cb796-132" tabindex="-1"></a>    fixed <span class="ot">&lt;-</span> model<span class="sc">$</span>summary.fixed[<span class="st">&#39;Intercept&#39;</span>, <span class="st">&#39;mean&#39;</span>] <span class="co">#fixed effects</span></span>
<span id="cb796-133"><a href="model-fit-checks-and-cross-validation.html#cb796-133" tabindex="-1"></a>    <span class="cf">for</span>(covariate <span class="cf">in</span> cov){</span>
<span id="cb796-134"><a href="model-fit-checks-and-cross-validation.html#cb796-134" tabindex="-1"></a>      fixed <span class="ot">&lt;-</span> fixed <span class="sc">+</span> model<span class="sc">$</span>summary.fixed[<span class="fu">paste0</span>(covariate), <span class="st">&#39;mean&#39;</span>] <span class="sc">*</span></span>
<span id="cb796-135"><a href="model-fit-checks-and-cross-validation.html#cb796-135" tabindex="-1"></a>        test[,<span class="fu">paste0</span>(covariate)]</span>
<span id="cb796-136"><a href="model-fit-checks-and-cross-validation.html#cb796-136" tabindex="-1"></a>      }</span>
<span id="cb796-137"><a href="model-fit-checks-and-cross-validation.html#cb796-137" tabindex="-1"></a>    <span class="co">#add settlement type and region nested effects</span></span>
<span id="cb796-138"><a href="model-fit-checks-and-cross-validation.html#cb796-138" tabindex="-1"></a>    fixed <span class="ot">=</span> fixed <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(test), <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>model<span class="sc">$</span>summary.hyperpar<span class="sc">$</span>mean[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb796-139"><a href="model-fit-checks-and-cross-validation.html#cb796-139" tabindex="-1"></a>      <span class="co">#add settlement type random effect</span></span>
<span id="cb796-140"><a href="model-fit-checks-and-cross-validation.html#cb796-140" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="fu">nrow</span>(test), <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>model<span class="sc">$</span>summary.hyperpar<span class="sc">$</span>mean[<span class="dv">5</span>]) <span class="sc">+</span> </span>
<span id="cb796-141"><a href="model-fit-checks-and-cross-validation.html#cb796-141" tabindex="-1"></a>      <span class="co">#add uncorrelated spatial random effects</span></span>
<span id="cb796-142"><a href="model-fit-checks-and-cross-validation.html#cb796-142" tabindex="-1"></a>      mod<span class="sc">$</span>summary.random<span class="sc">$</span>IDsr[<span class="st">&#39;mean&#39;</span>][test_ind,<span class="dv">1</span>] <span class="sc">+</span> field_mean[test_ind,<span class="dv">1</span>]</span>
<span id="cb796-143"><a href="model-fit-checks-and-cross-validation.html#cb796-143" tabindex="-1"></a></span>
<span id="cb796-144"><a href="model-fit-checks-and-cross-validation.html#cb796-144" tabindex="-1"></a>    dens_ht <span class="ot">&lt;-</span> <span class="fu">exp</span>(fixed)</span>
<span id="cb796-145"><a href="model-fit-checks-and-cross-validation.html#cb796-145" tabindex="-1"></a>    <span class="fu">sum</span>(pop_ht <span class="ot">&lt;-</span> dens_ht<span class="sc">*</span>test<span class="sc">$</span>bld)</span>
<span id="cb796-146"><a href="model-fit-checks-and-cross-validation.html#cb796-146" tabindex="-1"></a>   </span>
<span id="cb796-147"><a href="model-fit-checks-and-cross-validation.html#cb796-147" tabindex="-1"></a>    <span class="co">#scatter plots for each fold, uncomment for plots to show</span></span>
<span id="cb796-148"><a href="model-fit-checks-and-cross-validation.html#cb796-148" tabindex="-1"></a>    <span class="co"># par(mfrow = c(1,1))</span></span>
<span id="cb796-149"><a href="model-fit-checks-and-cross-validation.html#cb796-149" tabindex="-1"></a>    <span class="co"># plot(test$obs, pop_ht, xlab = &quot;Observed&quot;,</span></span>
<span id="cb796-150"><a href="model-fit-checks-and-cross-validation.html#cb796-150" tabindex="-1"></a>    <span class="co">#      ylab = &quot;Predicted&quot;, col = c(&#39;blue&#39;,&#39;orange&#39;),</span></span>
<span id="cb796-151"><a href="model-fit-checks-and-cross-validation.html#cb796-151" tabindex="-1"></a>    <span class="co">#      pch = c(16,16), cex.axis = 1.5)</span></span>
<span id="cb796-152"><a href="model-fit-checks-and-cross-validation.html#cb796-152" tabindex="-1"></a>    <span class="co"># abline(0,1)</span></span>
<span id="cb796-153"><a href="model-fit-checks-and-cross-validation.html#cb796-153" tabindex="-1"></a>    <span class="co"># legend(&quot;topleft&quot;, c(&quot;Observed&quot;, &quot;Predicted&quot;), col = c(&quot;blue&quot;, &quot;orange&quot;),</span></span>
<span id="cb796-154"><a href="model-fit-checks-and-cross-validation.html#cb796-154" tabindex="-1"></a>    <span class="co">#        pch = c(16,16), bty = &quot;n&quot;, cex = 1.5)</span></span>
<span id="cb796-155"><a href="model-fit-checks-and-cross-validation.html#cb796-155" tabindex="-1"></a>    </span>
<span id="cb796-156"><a href="model-fit-checks-and-cross-validation.html#cb796-156" tabindex="-1"></a>    <span class="co">#calculate fit metrics</span></span>
<span id="cb796-157"><a href="model-fit-checks-and-cross-validation.html#cb796-157" tabindex="-1"></a>    met_out <span class="ot">&lt;-</span> <span class="fu">model_metrics</span>(test<span class="sc">$</span>pop, pop_ht)</span>
<span id="cb796-158"><a href="model-fit-checks-and-cross-validation.html#cb796-158" tabindex="-1"></a>    </span>
<span id="cb796-159"><a href="model-fit-checks-and-cross-validation.html#cb796-159" tabindex="-1"></a>    met_list_out[[i]]<span class="ot">&lt;-</span> <span class="fu">unlist</span>(met_out)</span>
<span id="cb796-160"><a href="model-fit-checks-and-cross-validation.html#cb796-160" tabindex="-1"></a>    pred_list_out[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">obs =</span> test<span class="sc">$</span>obs, <span class="at">pred =</span> pop_ht,</span>
<span id="cb796-161"><a href="model-fit-checks-and-cross-validation.html#cb796-161" tabindex="-1"></a>                                     <span class="at">fold =</span> <span class="fu">rep</span>(i, <span class="fu">length</span>(test<span class="sc">$</span>obs)),</span>
<span id="cb796-162"><a href="model-fit-checks-and-cross-validation.html#cb796-162" tabindex="-1"></a>                                     <span class="at">data =</span> <span class="fu">rep</span>(<span class="st">&quot;outsample&quot;</span>, <span class="fu">length</span>(test<span class="sc">$</span>obs)))</span>
<span id="cb796-163"><a href="model-fit-checks-and-cross-validation.html#cb796-163" tabindex="-1"></a>  }</span>
<span id="cb796-164"><a href="model-fit-checks-and-cross-validation.html#cb796-164" tabindex="-1"></a>  met_list_out_dat <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind,met_list_out)</span>
<span id="cb796-165"><a href="model-fit-checks-and-cross-validation.html#cb796-165" tabindex="-1"></a>  </span>
<span id="cb796-166"><a href="model-fit-checks-and-cross-validation.html#cb796-166" tabindex="-1"></a>  <span class="co">#fit metrics</span></span>
<span id="cb796-167"><a href="model-fit-checks-and-cross-validation.html#cb796-167" tabindex="-1"></a>  metrics_out <span class="ot">&lt;-</span> <span class="fu">apply</span>(met_list_out_dat, <span class="dv">2</span>, mean)</span>
<span id="cb796-168"><a href="model-fit-checks-and-cross-validation.html#cb796-168" tabindex="-1"></a>  </span>
<span id="cb796-169"><a href="model-fit-checks-and-cross-validation.html#cb796-169" tabindex="-1"></a>  <span class="co">#predictions</span></span>
<span id="cb796-170"><a href="model-fit-checks-and-cross-validation.html#cb796-170" tabindex="-1"></a>  pred_list_out_dat <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind,pred_list_out)</span>
<span id="cb796-171"><a href="model-fit-checks-and-cross-validation.html#cb796-171" tabindex="-1"></a>  </span>
<span id="cb796-172"><a href="model-fit-checks-and-cross-validation.html#cb796-172" tabindex="-1"></a>  cv_mets <span class="ot">&lt;-</span> <span class="fu">rbind</span>(metrics_in, metrics_out)</span>
<span id="cb796-173"><a href="model-fit-checks-and-cross-validation.html#cb796-173" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">list</span>( <span class="at">met_list_in_dat =</span> met_list_in_dat,</span>
<span id="cb796-174"><a href="model-fit-checks-and-cross-validation.html#cb796-174" tabindex="-1"></a>                  <span class="at">met_list_out_dat =</span> met_list_out_dat,</span>
<span id="cb796-175"><a href="model-fit-checks-and-cross-validation.html#cb796-175" tabindex="-1"></a>                  <span class="at">pred_dat =</span> <span class="fu">rbind</span>(pred_list_in_dat, pred_list_out_dat),</span>
<span id="cb796-176"><a href="model-fit-checks-and-cross-validation.html#cb796-176" tabindex="-1"></a>                  <span class="at">cv_metrics =</span> <span class="fu">rbind</span>(metrics_in, metrics_out))</span>
<span id="cb796-177"><a href="model-fit-checks-and-cross-validation.html#cb796-177" tabindex="-1"></a>}</span></code></pre></div>
<p>To apply this function, the data from Cameroon is used as an example. In this example, the dataset is called <code>dat</code>, the number of folds utilised is <code>5</code>, the chosen model is called <code>mod4</code> with corresponding formula in the <code>INLA</code> model <code>form4</code>, projection matrix <code>A</code> and seed number <code>13235</code> (for reproducibility). Additionally, the vectors containing the selected covariate information, <code>cov</code> and <code>cov2</code>, are defined prior to running the function.</p>
<div class="sourceCode" id="cb797"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb797-1"><a href="model-fit-checks-and-cross-validation.html#cb797-1" tabindex="-1"></a><span class="co">#results from k-fold cross validation</span></span>
<span id="cb797-2"><a href="model-fit-checks-and-cross-validation.html#cb797-2" tabindex="-1"></a>cov <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;x2&#39;</span>, <span class="st">&#39;x3&#39;</span>, <span class="st">&#39;x17&#39;</span>, <span class="st">&#39;x21&#39;</span>, <span class="st">&#39;x32&#39;</span>, <span class="st">&#39;x34&#39;</span>, <span class="st">&#39;x40&#39;</span>, <span class="st">&#39;x42&#39;</span>)</span>
<span id="cb797-3"><a href="model-fit-checks-and-cross-validation.html#cb797-3" tabindex="-1"></a>cov2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;set_reg&quot;</span>, <span class="st">&quot;set_typ&quot;</span>, <span class="st">&quot;region&quot;</span>, <span class="st">&quot;IDsr&quot;</span>)</span>
<span id="cb797-4"><a href="model-fit-checks-and-cross-validation.html#cb797-4" tabindex="-1"></a>cross_val <span class="ot">&lt;-</span> <span class="fu">cross_validate</span>(<span class="at">dat =</span> dat,</span>
<span id="cb797-5"><a href="model-fit-checks-and-cross-validation.html#cb797-5" tabindex="-1"></a>                             <span class="at">n.folds =</span> <span class="dv">5</span>, </span>
<span id="cb797-6"><a href="model-fit-checks-and-cross-validation.html#cb797-6" tabindex="-1"></a>                             <span class="at">mod =</span> mod4, </span>
<span id="cb797-7"><a href="model-fit-checks-and-cross-validation.html#cb797-7" tabindex="-1"></a>                             <span class="at">form =</span> form4,</span>
<span id="cb797-8"><a href="model-fit-checks-and-cross-validation.html#cb797-8" tabindex="-1"></a>                             <span class="at">A =</span> A, </span>
<span id="cb797-9"><a href="model-fit-checks-and-cross-validation.html#cb797-9" tabindex="-1"></a>                             <span class="at">cov =</span> cov,</span>
<span id="cb797-10"><a href="model-fit-checks-and-cross-validation.html#cb797-10" tabindex="-1"></a>                             <span class="at">cov2 =</span> cov2,</span>
<span id="cb797-11"><a href="model-fit-checks-and-cross-validation.html#cb797-11" tabindex="-1"></a>                             <span class="at">seed =</span> <span class="dv">13235</span>)</span></code></pre></div>
<pre><code>## [1] &quot;in-sample cross-validation using fold 1&quot;
## [1] &quot;in-sample cross-validation using fold 2&quot;
## [1] &quot;in-sample cross-validation using fold 3&quot;
## [1] &quot;in-sample cross-validation using fold 4&quot;
## [1] &quot;in-sample cross-validation using fold 5&quot;
## [1] &quot;out-of-sample cross-validation using fold 1&quot;
## [1] &quot;out-of-sample cross-validation using fold 2&quot;
## [1] &quot;out-of-sample cross-validation using fold 3&quot;
## [1] &quot;out-of-sample cross-validation using fold 4&quot;
## [1] &quot;out-of-sample cross-validation using fold 5&quot;</code></pre>
<div class="sourceCode" id="cb799"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb799-1"><a href="model-fit-checks-and-cross-validation.html#cb799-1" tabindex="-1"></a><span class="co">#in-sample metrics per fold </span></span>
<span id="cb799-2"><a href="model-fit-checks-and-cross-validation.html#cb799-2" tabindex="-1"></a>cross_val<span class="sc">$</span>met_list_in_dat  </span></code></pre></div>
<pre><code>##           MAE     RMSE     BIAS        CC
## [1,] 154.0561 327.7893 95.22379 0.9902840
## [2,] 139.0922 196.5983 82.62810 0.9887830
## [3,] 141.9625 224.6575 74.04167 0.9801556
## [4,] 142.4847 211.9439 79.10194 0.9781099
## [5,] 141.4359 223.6698 74.50207 0.9864906</code></pre>
<div class="sourceCode" id="cb801"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb801-1"><a href="model-fit-checks-and-cross-validation.html#cb801-1" tabindex="-1"></a><span class="co">#out-of-sample metrics per fold</span></span>
<span id="cb801-2"><a href="model-fit-checks-and-cross-validation.html#cb801-2" tabindex="-1"></a>cross_val<span class="sc">$</span>met_list_out_dat </span></code></pre></div>
<pre><code>##           MAE     RMSE      BIAS        CC
## [1,] 160.7173 339.8842  61.73926 0.9836105
## [2,] 141.5075 198.4901  69.18201 0.9874822
## [3,] 177.8058 302.0186 119.58316 0.9721151
## [4,] 169.6710 268.6756 140.74931 0.9750293
## [5,] 132.1042 193.2967  59.91717 0.9854916</code></pre>
<div class="sourceCode" id="cb803"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb803-1"><a href="model-fit-checks-and-cross-validation.html#cb803-1" tabindex="-1"></a><span class="co">#combined averaged metrics</span></span>
<span id="cb803-2"><a href="model-fit-checks-and-cross-validation.html#cb803-2" tabindex="-1"></a>cross_val<span class="sc">$</span>cv_metrics    </span></code></pre></div>
<pre><code>##                  MAE     RMSE     BIAS        CC
## metrics_in  143.8063 236.9318 81.09951 0.9847646
## metrics_out 156.3612 260.4731 90.23418 0.9807457</code></pre>
<div class="sourceCode" id="cb805"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb805-1"><a href="model-fit-checks-and-cross-validation.html#cb805-1" tabindex="-1"></a><span class="co">#combined prediction data</span></span>
<span id="cb805-2"><a href="model-fit-checks-and-cross-validation.html#cb805-2" tabindex="-1"></a><span class="fu">head</span>(cross_val<span class="sc">$</span>pred_dat)</span></code></pre></div>
<pre><code>##    obs      pred fold     data
## 1 1886 1685.1565    1 insample
## 2  908  978.4384    1 insample
## 3  545  631.0405    1 insample
## 4  768  862.1703    1 insample
## 5  915  976.8425    1 insample
## 6  912 1074.9687    1 insample</code></pre>
<div class="sourceCode" id="cb807"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb807-1"><a href="model-fit-checks-and-cross-validation.html#cb807-1" tabindex="-1"></a><span class="fu">tail</span>(cross_val<span class="sc">$</span>pred_dat)</span></code></pre></div>
<pre><code>##       obs      pred fold      data
## 4575 1291 1026.8244    5 outsample
## 4576 1028  849.8356    5 outsample
## 4577  283  228.0998    5 outsample
## 4578  346  329.3237    5 outsample
## 4579  691  720.8671    5 outsample
## 4580  373  399.1697    5 outsample</code></pre>
</div>
<div id="useful-resources-7" class="section level3 hasAnchor" number="9.3.3">
<h3><span class="header-section-number">9.3.3</span> Useful resources<a href="model-fit-checks-and-cross-validation.html#useful-resources-7" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li>WAIC: <a href="https://www.nature.com/articles/s41598-024-66643-4#:~:text=One%20common%20method%20used%20for%20Bayesian%20model%20selection,value%20that%20can%20be%20compared%20between%20alternative%20models.">Nature</a></li>
<li>WAIC: <a href="https://sites.stat.columbia.edu/gelman/research/unpublished/loo_stan.pdf">Columbia</a></li>
<li>DIC: <a href="https://dm13450.github.io/2018/01/18/DIC.html">Dean Marwick</a></li>
<li>CPO: <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC3985471/">Posterior Predictive Bayesian Phulogenetic Model Selection</a></li>
<li>PIT: <a href="https://becarioprecario.bitbucket.io/inla-gitbook/ch-INLA.html">Bayesian inference with INLA</a></li>
<li>INLA-SPDE approach: <a href="https://datascienceplus.com/spatial-regression-in-r-part-2-inla/">datascience+</a></li>
</ul>
<!-- A brief breakdown of the methods utilised within the cross-validation is given, with a more in-depth explanation of the methods given in Module 10. -->
<!-- Firstly, for the pre-processing, the number of folds needs to be chosen, for this example, there will be `k = 10` folds. -->
<!-- ```{r choose number of folds} -->
<!-- #choose the number of folds -->
<!-- k=10 -->
<!-- ``` -->
<!-- Additionally, the number of observations needs to be defined as the number of rows in the dataset. -->
<!-- ```{r number of observations} -->
<!-- #define the number of observations -->
<!-- n <- nrow(Data_CMR_std) -->
<!-- ``` -->
<!-- Once the number of observations and desired number of folds have been defined, the folds themselves can be defined. To do this, the size of each fold is found through dividing the number of observations by the number of folds, and selecting the nearest integer. For this operation, the integer division operator $%/%$ can be used. The folds themselves can then be sampled. -->
<!-- ```{define the folds} -->
<!-- #define the folds -->
<!-- fold_size <- n %/% k -->
<!-- folds <- sample(rep(1:k, each = fold_size, length.out = n)) -->
<!-- ``` -->
<!-- A data frame containing the names of the test values and predictions is then created outside of the loop. Each iteration of the cross-validation will add the corresponding values to the results data frame. -->
<!-- ```{r create data frames} -->
<!-- #create a data frame to store the test values and predictions outside of loop -->
<!-- results_df <- data.frame(EA_ID = numeric(), -->
<!--                          Total_Building_Count = numeric(),  -->
<!--                          folds = numeric(),  -->
<!--                          observed_density = numeric(),  -->
<!--                          predicted_density = numeric(),  -->
<!--                          observed_population = numeric(),  -->
<!--                          predicted_population =numeric()) -->
<!-- ``` -->
<!-- The last part of the pre-processing is to set the start values for the model metrics to zero, for each of the density and population, test and training data metrics. -->
<!-- ```{r start values for model metrics} -->
<!-- #set start value for model metrics -->
<!-- #density training data metrics -->
<!-- dens_train_MAE = dens_train_RMSE = dens_train_BIAS = -->
<!--   dens_train_CORR = 0 -->
<!-- #population training data metrics -->
<!-- pop_train_MAE = pop_train_RMSE = pop_train_BIAS =  -->
<!--   pop_train_CORR = 0 -->
<!-- #density test data metrics -->
<!-- dens_test_MAE = dens_test_RMSE = dens_test_BIAS = -->
<!--   dens_test_CORR = 0 -->
<!-- #population test data metrics -->
<!-- pop_test_MAE = pop_test_RMSE = pop_test_BIAS = -->
<!--   pop_test_CORR = 0 -->
<!-- ``` -->
<!-- The next step is the cross-validation itself. As mentioned earlier, the prediction methods used within the cross-validation are given in more detail in Module 10, but the basic breakdown of the steps are given below. -->
<!-- -   Create a for loop to conduct the cross-validation for each of the number of folds. -->
<!--     -   Split the data into the test data and the training data. -->
<!--     -   Define the coordinates of the centroids and construct the mesh for the training data. -->
<!--     -   Follow the INLA-SPDE approach in Module 8 (building a projection matrix, creating the SPDE, specifying the observation indices for estimation, selecting the covariates, stacking the data for estimation, specifying and fitting the model). -->
<!--     -   Extract the in-sample predictions. -->
<!--     -   Obtain the observed population and density to use in the training model metric assessment. -->
<!--     -   Obtain the predicted population and rename the variables to be in a proper format. -->
<!--     -   Compute the training data metrics. -->
<!--     -   Make predictions for the test data by sampling from the posteriors for the test predictions and sampling from the posteriors in the model. -->
<!--     -   Assign the posteriors to the settlement classes. -->
<!--     -   Get the spatial effect parameter in the SPDE and estimate the values for the spatial component in the test data. -->
<!--     -   Extract the test covariates and covert to a matrix. -->
<!--     -   Predict the fixed effect covariates. -->
<!--     -   Predict the posterior density estimates and summarise values. -->
<!--     -   Compute both the test data and training data metrics. -->
<!--     -   Return a list of the density and population metrics. -->
<!--     ```{r k-fold cv, eval=FALSE} -->
<!--     #implementation of the loop for k-fold CV -->
<!--     for (i in 1:k){ -->
<!--       #define the test and train indices -->
<!--       train_indices <- which(folds == i) -->
<!--       test_indices <- which(folds != i) -->
<!--       #obtain the test and train data -->
<!--       train_data <- Data_CMR_std[train_indices, ] -->
<!--       test_data <- Data_CMR_std[test_indices, ] -->
<!--       #print text to give progress of loop -->
<!--       print(paste("Processing fold", i, "out of", k)) -->
<!--       #define the coordinates of the centroids -->
<!--       coords <- cbind(train_data$long, train_data$lat) -->
<!--       #construct the training data mesh -->
<!--       bnd <- inla.nonconvex.hull(coords, -0.03, -0.05, resolution = c(100, 100)) -->
<!--       train_mesh <- inla.mesh.2d(boundary = bnd, -->
<!--                                  max.edge = c(0.1, 1), -->
<!--                                  offset = c(0.05, 1),  -->
<!--                                  cutoff = 0.003)  -->
<!--       #plot the resulting mesh -->
<!--       plot(train_mesh) -->
<!--       #build a projection matrix -->
<!--       A <- inla.spde.make.A(mesh = train_mesh, loc = as.matrix(coords)) -->
<!--       #create the SPDE -->
<!--       train_spde <- inla.spde2.matern(train_mesh, alpha = 2) -->
<!--       #specify the observation indices for estimation -->
<!--       indexs <- inla.spde.make.index(name = "spatial.field", train_spde$n.spde) -->
<!--       #select the best covariates -->
<!--       train_covs <- train_data %>% -->
<!--         dplyr::select(x3, x4, x7, x16, x20, x31, x37, x40, Settlement_Type) -->
<!--       #stack the data for model fitting -->
<!--       stk.e <- inla.stack(data = list(y = train_data$Density), -->
<!--                           A = list(A,1), -->
<!--                           effects = list(c(list(Intercept=1), -->
<!--                                          indexs),  -->
<!--                                        list(train_covs)  -->
<!--                           ), -->
<!--                           tag = 'est')  -->
<!--       #specify the chosen model -->
<!--       formula2 <- y ~ -1 + Intercept + x3 + x4 + x7 + x16 + x20 + x31 + x37 +x40 + -->
<!--         f(spatial.field, model = train_spde)+ -->
<!--         f(Settlement_Type, model = "iid") -->
<!--       #fit model using a gamma distribution -->
<!--       mod2 <- inla(formula2,  -->
<!--                    data = inla.stack.data(stk.e,spde=train_spde),   -->
<!--                    family = 'gamma',   -->
<!--                    control.predictor=list(A=inla.stack.A(stk.e),compute = TRUE),  -->
<!--                    control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE, -->
<!--                                           config = TRUE, config = T),  -->
<!--                    verbose = FALSE,  -->
<!--                    control.inla=list(int.strategy = "grid", diff.logdens = 4, -->
<!--                                      strategy = "laplace", npoints = 21)) -->
<!--       #extract the in-sample predictions -->
<!--       index <- inla.stack.index(stk.e, "est")$data -->
<!--       density_predict <- data.frame(predicted_density = -->
<!--                                       exp(mod2$summary.linear.predictor[index, -->
<!--                                                                         "mean"])) -->
<!--       #obtain the observed population and density from the training data to use for  -->
<!--       #training model metric assessment -->
<!--       train_predict <- train_data %>%  -->
<!--         dplyr::select(Total_Pop, Density, Total_Building_Count) %>%  -->
<!--         cbind(density_predict) -->
<!--       #obtain the predicted population -->
<!--       train_predict <- train_predict %>%  -->
<!--         mutate(predicted_population = predicted_density * Total_Building_Count) -->
<!--       #rename the variables to be in the proper format -->
<!--       train_predict <- train_predict %>%  -->
<!--         dplyr::rename(observed_population = Total_Pop, observed_density = Density) -->
<!--       #obtain the training data metrics for the density -->
<!--       dens_train_metrics <- round(unlist(mod_metrics(train_predict$observed_density,  -->
<!--                                                   train_predict$predicted_density)), -->
<!--                                   4) -->
<!--       dens_train_MAE <- dens_train_MAE + dens_train_metrics[1] -->
<!--       dens_train_RMSE <- dens_train_RMSE + dens_train_metrics[2] -->
<!--       dens_train_BIAS <- dens_train_BIAS + dens_train_metrics[3] -->
<!--       dens_train_CORR <- dens_train_CORR + dens_train_metrics[4] -->
<!--       #obtain the training data metrics for the population -->
<!--       pop_train_metrics <- round(unlist(mod_metrics(train_predict$observed_population, -->
<!--                                               train_predict$predicted_population)), -->
<!--                            4) -->
<!--       pop_train_MAE <- pop_train_MAE + pop_train_metrics[1] -->
<!--       pop_train_RMSE <- pop_train_RMSE + pop_train_metrics[2] -->
<!--       pop_train_BIAS <- pop_train_BIAS + pop_train_metrics[3] -->
<!--       pop_train_CORR <- pop_train_CORR + pop_train_metrics[4] -->
<!--       #make predictions for the test data -->
<!--       #take samples from the posteriors for the test predictions -->
<!--       samples <- inla.posterior.sample(n = 100, result = mod2,  -->
<!--                                        num.threads = "1:1") -->
<!--       #sample from the posterior in the model -->
<!--       sample_extract <- inla.posterior.sample.eval( -->
<!--         (function(...){ -->
<!--           beta.1 <- get("x3") -->
<!--           beta.2 <- get("x4") -->
<!--           beta.3 <- get("x7") -->
<!--           beta.4 <- get("x16") -->
<!--           beta.5 <- get("x20") -->
<!--           beta.6 <- get("x31") -->
<!--           beta.7 <- get("x37") -->
<!--           beta.8 <- get("x40") -->
<!--           prec.1 <- get("Settlement_Type") -->
<!--           return(c(Intercept, beta.1, beta.2,beta.3, beta.4, beta.5, beta.6, -->
<!--                    beta.7, beta.8, prec.1)) -->
<!--         }), samples) -->
<!--       #save the posteriors in a new object to make them easy to identify -->
<!--       Intercept <- sample_extract[1,] -->
<!--       betas <- sample_extract[2:9,] -->
<!--       alpha_settlement_type <- sample_extract[10:13,] #random effect for  -->
<!--                                                       #settlement type -->
<!--       alpha_settlement_type <- alpha_settlement_type %>% -->
<!--         as_tibble() %>% -->
<!--         mutate(Settlement_Type = c(1, 2, 3, 4)) -->
<!--       #assign posteriors to the settlement classes -->
<!--       predict_settlement_type <- test_data %>% -->
<!--         dplyr::select(Settlement_Type) %>% -->
<!--         left_join(alpha_settlement_type, -->
<!--                   by = c("Settlement_Type" = "Settlement_Type")) %>% -->
<!--         dplyr::select(-Settlement_Type) -->
<!--       #get the spacial effect parameter in the SPDE, first by getting the -->
<!--       #xy coordinate of the predictions -->
<!--       coord1 <- cbind(test_data$long, test_data$lat) -->
<!--       #then remake the A matrix for the prediction -->
<!--       A_prediction <- inla.spde.make.A(mesh = train_mesh, loc = as.matrix(coord1)) -->
<!--       #get the spatial effect parameter from the model -->
<!--       spatial_field_nodes <- mod2$summary.random$spatial.field['mean'] -->
<!--       #estimate the values for the spatial component in the test data -->
<!--       spatial_field <- (A_prediction %*% as.data.frame(spatial_field_nodes)[,1]) -->
<!--       #extract the test covariates and convert them to matrix form -->
<!--       cov_fixed <- test_data %>% -->
<!--         dplyr::select(x3, x4, x7, x16, x20, x31, x37, x40) %>% -->
<!--         #avoid numerical issues with the following line -->
<!--         mutate_at(vars(starts_with("x")), ~replace(., is.na(.), 0)) %>% -->
<!--         as.matrix() -->
<!--       #predict for covariates by multiplying the betas by the corresponding  -->
<!--       #(fixed) covariate values -->
<!--       cov_fixed <- cov_fixed %*% betas  -->
<!--       cov_fixed <- as_tibble(cov_fixed) #convert to a data frame   -->
<!--       #predicted posterior density estimates -->
<!--       mu <- exp(Intercept + cov_fixed + predict_settlement_type + spatial_field[,1]) -->
<!--       #summarise the density mu -->
<!--       predicted_density <- rowMeans(mu, na.rm = TRUE) -->
<!--       #add building count to mu -->
<!--       mu <- mu %>%  -->
<!--         mutate(building_count = test_data$Total_Building_Count) -->
<!--       #estimate predicted population -->
<!--       predicted_pop <- mu %>% -->
<!--         mutate_at(vars(starts_with("sample")), ~ . * building_count) %>%  -->
<!--         select(-building_count) -->
<!--       #summarise the predictions -->
<!--       predicted_population <- rowMeans(predicted_pop, na.rm = TRUE) -->
<!--       test_predict <- test_data %>%  -->
<!--         select(Total_Pop, Total_Building_Count, Density, EA_ID) %>%  -->
<!--         cbind(predicted_density, predicted_population) -->
<!--       #rename variables to be in proper format  -->
<!--       test_predict <- test_predict %>% -->
<!--         rename(observed_population = Total_Pop, observed_density = Density) -->
<!--       #obtain the test data metrics for the density -->
<!--       dens_test_metrics <- round(unlist(mod_metrics(test_predict$observed_density, -->
<!--                                                     test_predict$predicted_density)), -->
<!--                                   4) -->
<!--       dens_test_MAE <- dens_test_MAE + dens_test_metrics[1] -->
<!--       dens_test_RMSE <- dens_test_RMSE + dens_test_metrics[2] -->
<!--       dens_test_BIAS <- dens_test_BIAS + dens_test_metrics[3] -->
<!--       dens_test_CORR <- dens_test_CORR + dens_test_metrics[4] -->
<!--       #obtain the test data metrics for the population -->
<!--       pop_test_metrics <- round(unlist(mod_metrics(test_predict$observed_population, -->
<!--                                                    test_predict$predicted_population)), -->
<!--                                  4) -->
<!--       pop_test_MAE <- pop_test_MAE + pop_test_metrics[1] -->
<!--       pop_test_RMSE <- pop_test_RMSE + pop_test_metrics[2] -->
<!--       pop_test_BIAS <- pop_test_BIAS + pop_test_metrics[3] -->
<!--       pop_test_CORR <- pop_test_CORR + pop_test_metrics[4] -->
<!--       #append observed and predictions to results_df with fold information -->
<!--       fold_results <- data.frame(EA_ID = test_predict$EA_ID,  -->
<!--                                  Total_Building_Count = test_predict$Total_Building_Count, -->
<!--                                  folds = i, observed_density = test_predict$observed_density,  -->
<!--                                  predicted_density = test_predict$predicted_density,  -->
<!--                                  observed_population = test_predict$observed_population,  -->
<!--                                  predicted_population = test_predict$predicted_population) -->
<!--       results_df <- rbind(results_df, fold_results) -->
<!--     } -->
<!--     ``` -->
<!--     Once the cross-validation has been conducted, the train and test metrics can be found through averaging the output across each of the folds. The final results can then be displayed in a table using the `kable()` function from the `knitr` package. -->
<!--     ```{r train and test metrics, eval=FALSE} -->
<!--     #train metrics averaged across all of the folds -->
<!--     train_metrics <- data.frame( -->
<!--       dens_train_MAE = dens_train_MAE/k, -->
<!--       dens_train_RMSE = dens_train_RMSE/k, -->
<!--       dens_train_BIAS = dens_train_BIAS/k, -->
<!--       dens_train_CORR = dens_train_CORR/k, -->
<!--       pop_train_MAE = pop_train_MAE/k, -->
<!--       pop_train_RMSE = pop_train_RMSE/k, -->
<!--       pop_train_BIAS = pop_train_BIAS/k, -->
<!--       pop_train_CORR = pop_train_CORR/k) -->
<!--     #test metrics averaged across all of the results -->
<!--     test_metrics <- data.frame( -->
<!--      dens_test_MAE = dens_test_MAE/k, -->
<!--      dens_test_RMSE = dens_test_RMSE/k, -->
<!--      dens_test_BIAS = dens_test_BIAS/k, -->
<!--      dens_test_CORR = dens_test_CORR/k, -->
<!--      pop_test_MAE = pop_test_MAE/k, -->
<!--      pop_test_RMSE = pop_test_RMSE/k, -->
<!--      pop_test_BIAS = pop_test_BIAS/k, -->
<!--      pop_test_CORR = pop_test_CORR/k) -->
<!--     #print results -->
<!--     train_metrics%>% -->
<!--       knitr::kable() -->
<!--     test_metrics%>% -->
<!--       kable() -->
<!--     ``` -->
<!-- ## Leave-One-Out Cross-Validation (LOOCV) -->
<!-- Leave-one-out cross-validation takes a long time to perform with large datasets, given that the number of folds (iterations) is equal to the number of observations in the available dataset. As a result of this, k-fold cross-validation is the favoured approach to utilise. However, if using leave-one-out cross-validation is desired, the above k-fold cross-validation code can be utilised, but changing the number of folds, `k`, to be equal to the number of rows in the data (`nrow(Data_CMR_std)`). -->
<!-- Leave-one-out cross validation typically takes a long time to perform with large datasets, so for demonstrative purposes, only 12 of the observations here will be sampled.  -->
<!-- ```{r sample observations} -->
<!-- #create sampled dataset -->
<!-- sampled_data <- Data_CMR_std %>%  -->
<!--   #group by settlement type to ensure samples are taken from the distinct  -->
<!--   #settlement types  -->
<!--   group_by(Settlement_Type) %>%  -->
<!--   sample_n(size = 12) %>%  -->
<!--   ungroup() -->
<!-- ``` -->
<!-- To conduct leave-one-out cross-validation in R, a function can be created as seen below. The following are the main steps within the function that are included.  -->
<!-- - Initialise the data frames to store the results for both the training metrics, the test metrics and the general results. -->
<!-- - Create placeholder variables for the key metrics, such as RMSE, pearson values, MAE and bias. These should be created for both the population and density for both the training and test data. -->
<!-- - Create a for loop to conduct the cross-validation for each of the rows in the data. -->
<!--   - Split the data into the test data and the training data. -->
<!--   - Define the coordinates of the centroids and construct the mesh for the training data. -->
<!--   - Follow the INLA-SPDE approach in Module 8 (building a projection matrix, creating the SPDE, specifying the observation indices for estimation, selecting the covariates, stacking the data for estimation, specifying and fitting the model). -->
<!--   - Extract the in-sample predictions. -->
<!--   - Obtain the observed population and density to use in the training model metric assessment. -->
<!--   - Obtain the predicted population and rename the variables to be in a proper format. -->
<!--   - Compute the training data metrics. -->
<!--   - Make predictions for the test data by sampling from the posteriors for the test predictions and sampling from the posteriors in the model. -->
<!--   - Assign the posteriors to the settlement classes. -->
<!--   - Get the spatial effect parameter in the SPDE and estimate the values for the spatial component in the test data. -->
<!--   - Extract the test covariates and covert to a matrix. -->
<!--   - Predict the fixed effect covariates. -->
<!--   - Predict the posterior density estimates and summarise values. -->
<!--   - Compute both the test data and training data metrics. -->
<!-- - Return a list of the density and population metrics. -->
<!-- ```{r LOOCV function} -->
<!-- #function to calculate LOOCV -->
<!--   loo_cv <- function(data) { -->
<!--     k <- nrow(data) -->
<!--     #initialise data frames to store results -->
<!--     train_metrics <- data.frame() -->
<!--     test_metrics <- data.frame() -->
<!--     results_df <- data.frame(EA_ID = numeric(), Total_Building_Count = numeric(), -->
<!--                              folds = numeric(), observed_density = numeric(), -->
<!--                              predicted_density = numeric(), observed_population = numeric(), -->
<!--                              predicted_population =numeric()) -->
<!--     #place holder for train metrics calculation ---------------------------- -->
<!--     #density metrics -->
<!--     dens_train_rmse_values <- numeric(k) # Placeholder for RMSE -->
<!--     dens_train_pearson_values <- numeric(k) # Placeholder for corr -->
<!--     dens_train_mae_values <- numeric(k)  # Placeholder for MAE -->
<!--     dens_train_bias_values <- numeric(k)  # Placeholder for bias -->
<!--     #population metrics -->
<!--     pop_train_rmse_values <- numeric(k) # Placeholder for RMSE -->
<!--     pop_train_pearson_values <- numeric(k) # Placeholder for corr -->
<!--     pop_train_mae_values <- numeric(k)  # Placeholder for MAE -->
<!--     pop_train_bias_values <- numeric(k)  # Placeholder for bias -->
<!--     #place holder for test metrics calculation ------------------------- -->
<!--     #density metrics -->
<!--     dens_test_rmse_values <- numeric(k) # Placeholder for RMSE -->
<!--     dens_test_pearson_values <- numeric(k) # Placeholder for corr -->
<!--     dens_test_mae_values <- numeric(k)  # Placeholder for MAE -->
<!--     dens_test_bias_values <- numeric(k)  # Placeholder for bias -->
<!--     #population metrics -->
<!--     pop_test_rmse_values <- numeric(k) # Placeholder for RMSE -->
<!--     pop_test_pearson_values <- numeric(k) # Placeholder for corr -->
<!--     pop_test_mae_values <- numeric(k)  # Placeholder for MAE -->
<!--     pop_test_bias_values <- numeric(k)  # Placeholder for bias -->
<!--     #for loop for implementation --------------------------------------------- -->
<!--     for (i in 1:k) { -->
<!--       test_index <- i -->
<!--       train_indices <- c(1: (test_index - 1), (test_index + 1):nrow(data)) -->
<!--       train_data <- data[train_indices, ] -->
<!--       test_data <- data[test_index, ] -->
<!--       print(paste("Processing fold", i, "out of", k)) -->
<!--     #define the coordinates of centroids -->
<!--     coords <- cbind(train_data$long, train_data$lat) -->
<!--     #construct train_data mesh -->
<!--     bnd <- inla.nonconvex.hull(coords, -0.03, -0.05, resolution = c(100, 100)) -->
<!--     train_mesh <- inla.mesh.2d(boundary = bnd, -->
<!--                                max.edge=c(0.1, 1), #adjusts the mesh nodes sizes -->
<!--                                #between the inner and outer meshes -->
<!--                                offset = c(0.05, 1), #adjusts the distance between  -->
<!--                                #the outer and inner meshes -->
<!--                                cutoff = 0.003) #controls the minimum size of  -->
<!--                                   #triangles allowed -->
<!--     #plot(train_mesh) -->
<!--     #data stake processing --------------------------------------------------- -->
<!--     #build a projector matrix -->
<!--     A <- inla.spde.make.A(mesh=train_mesh, loc=as.matrix(coords)) -->
<!--     #create the SPDE -->
<!--     train_spde <- inla.spde2.matern(train_mesh, alpha=2) -->
<!--     #specify the observation indices for estimation  -->
<!--     indexs <- inla.spde.make.index(name = "spatial.field", train_spde$n.spde) -->
<!--     #covariates -->
<!--     train_covs <- train_data %>% -->
<!--       dplyr::select(x3, x4, x7, x16, x20, x31, x37, x40, Settlement_Type) -->
<!--     #stack the data for model fitting -->
<!--     stk.e <- inla.stack(data=list(y = train_data$Density), #the response variable -->
<!--                         A=list(A,1),  #the A matrix; the 1 is included to make -->
<!--                           #the list(covariates) -->
<!--                         effects=list(c(list(Intercept=1), #the Intercept -->
<!--                                        indexs),  #the spatial index -->
<!--                                      list(train_covs) #the covariates -->
<!--                         ), -->
<!--                         tag='est') #quick name to call upon easily -->
<!--     #specify model  -->
<!--     formula2 <- y ~ -1 + Intercept + x3 + x4 + x7 + x16 + x20 + x31 + x37 +x40 + -->
<!--       f(spatial.field, model = train_spde)+ -->
<!--       f(Settlement_Type, model = "iid") -->
<!--     #fit model using a gamma distribution -->
<!--     #can also use a lognormal distribution  -->
<!--     mod2 <- inla(formula2,  -->
<!--                  data=inla.stack.data(stk.e,spde=train_spde),  #the data stack -->
<!--                  family= 'gamma',   -->
<!--                  control.predictor=list(A=inla.stack.A(stk.e),compute=TRUE),  -->
<!--                  #compute gives you the marginals of the linear predictor -->
<!--                  control.compute = list(dic = TRUE, waic = TRUE, cpo=TRUE, -->
<!--                                         config = TRUE, config = T),  -->
<!--                  #model diagnostics and config = TRUE gives you the GMRF -->
<!--                  verbose = FALSE,  -->
<!--                  control.inla=list(int.strategy = "grid", diff.logdens = 4, -->
<!--                                    strategy = "laplace", npoints = 21)) -->
<!--     #summary(mod2) -->
<!--     #extract in-sample predictions -->
<!--     index <-inla.stack.index(stk.e, "est")$data  -->
<!--     density_predictions <-  -->
<!--       data.frame(predicted_density =  -->
<!--                    exp(mod2$summary.linear.predictor[index, "mean"])) -->
<!--     #get observed population and observed density from the train_data and use it  -->
<!--     #for train model metric assessment -->
<!--     train_predictions <- train_data %>%  -->
<!--       select(Total_Pop, Density, Total_Building_Count) %>%  -->
<!--       cbind(density_predictions) -->
<!--     #to obtain the predicted population, multiply the predicted density by the  -->
<!--     #Total_Building_Count -->
<!--     train_predictions <- train_predictions %>%  -->
<!--       mutate(predicted_population = predicted_density * Total_Building_Count) -->
<!--     #rename variables in proper format -->
<!--     train_predictions <- train_predictions %>%  -->
<!--       rename(observed_population = Total_Pop, observed_density = Density) -->
<!--     #train data metrics -->
<!--     #density -->
<!--     dens_train_rmse_values[i] <- sqrt(mean((train_predictions$observed_density - train_predictions$predicted_density)^2)) -->
<!--     dens_train_pearson_values[i] <- cor(train_predictions$observed_density, train_predictions$predicted_density) -->
<!--     dens_train_mae_values[i] <- mean(abs(train_predictions$observed_density - train_predictions$predicted_density)) -->
<!--     dens_train_bias_values[i] <- mean(train_predictions$observed_density - train_predictions$predicted_density) -->
<!--     #population -->
<!--     pop_train_rmse_values[i] <- sqrt(mean((train_predictions$observed_population - train_predictions$predicted_population)^2)) -->
<!--     pop_train_pearson_values[i] <- cor(train_predictions$observed_population, train_predictions$predicted_population) -->
<!--     pop_train_mae_values[i] <- mean(abs(train_predictions$observed_population - train_predictions$predicted_population)) -->
<!--     pop_train_bias_values[i] <- mean(train_predictions$observed_population - train_predictions$predicted_population) -->
<!--     #make predictions for test data ------------------------------------------ -->
<!--     #sample from posteriors for test predictions -->
<!--     samples <- inla.posterior.sample(n = 1, result = mod2, num.threads = "1:1") -->
<!--     #sample from posterior in model -->
<!--     sam.extract <- inla.posterior.sample.eval( -->
<!--       (function(...) { -->
<!--         beta.1 <- get("x3") -->
<!--         beta.2 <- get("x4") -->
<!--         beta.3 <- get("x7") -->
<!--         beta.4 <- get("x16") -->
<!--         beta.5 <- get("x20") -->
<!--         beta.6 <- get("x31") -->
<!--         beta.7 <- get("x37") -->
<!--         beta.8 <- get("x40") -->
<!--         prec.1 <- get("Settlement_Type") -->
<!--         return(c(Intercept, beta.1, beta.2,beta.3, beta.4, beta.5, beta.6,  -->
<!--                  beta.7, beta.8, prec.1)) -->
<!--       }), samples) -->
<!--     #print(round(dig = 4, rowMeans(sam.extract)))  #summarised posteriors -->
<!--     #save posteriors in new object to make them easier to identify -->
<!--     Intercept <- sam.extract[1, ]        #Intercept -->
<!--     betas <- sam.extract[2:9, ]          #betas -->
<!--     alpha_settlement_type <- sam.extract[10:13, ]   #random effect for -->
<!--         #settlement types -->
<!--     alpha_settlement_type <- alpha_settlement_type %>%   -->
<!--       as_tibble() %>%  -->
<!--       mutate(Settlement_Type = c(1, 2, 3, 4)) -->
<!--     #make predictions -->
<!--     #assign posteriors to Settlement Classes -->
<!--     predict_settlement_type <- test_data %>%  -->
<!--       dplyr::select(Settlement_Type)%>%  -->
<!--       left_join(alpha_settlement_type, by =  -->
<!--                   c("Settlement_Type" = "Settlement_Type")) %>%  -->
<!--       dplyr::select(-Settlement_Type)  -->
<!--     #get the spatial effect parameter in the SPDE -->
<!--     #xy coordinate of predictions -->
<!--     coord1 <- cbind(test_data$long, test_data$lat)  -->
<!--     #remake the A matrix for prediction -->
<!--     Aprediction <- inla.spde.make.A(mesh = train_mesh, loc = as.matrix(coord1)) -->
<!--     dim(Aprediction) -->
<!--     #get the spatial effect parameter from the model -->
<!--     sfield_nodes <- mod2$summary.random$spatial.field['mean'] -->
<!--     dim(sfield_nodes) -->
<!--     #estimate the values for the spatial component in the test data -->
<!--     spatial_field <- (Aprediction %*% as.data.frame(sfield_nodes)[, 1]) -->
<!--     #extract test covariates and convert to matrix -->
<!--     cov_fixed <- test_data %>%  -->
<!--       dplyr::select(x3, x4, x7, x16, x20, x31, x37, x40) %>%  -->
<!--       mutate_at(vars(starts_with("x")), ~replace(., is.na(.), 0)) %>%  #this is  -->
<!--           #to avoid numerical issues -->
<!--       as.matrix()  -->
<!--     #predict for covariates (fixed effect) -->
<!--     cov_fixed <- cov_fixed %*% betas #multiply the estimated beta parameters -->
<!--       #with their respective covariates -->
<!--     cov_fixed <- as_tibble(cov_fixed) #convert to data frame -->
<!--     #predicted posterior density estimates -->
<!--     mu <- exp(Intercept + cov_fixed + predict_settlement_type +  -->
<!--                 spatial_field[,1]) #model -->
<!--     #summarise density mu -->
<!--     predicted_density <- rowMeans(mu, na.rm = T) -->
<!--     #add building count to mu -->
<!--     mu <- mu %>%  -->
<!--       mutate(building_count = test_data$Total_Building_Count) -->
<!--     #estimate predicted population -->
<!--     predicted_pop <- mu %>% -->
<!--       mutate_at(vars(starts_with("sample")), ~ . * building_count) %>%  -->
<!--       select(-building_count) -->
<!--     #summarise predictions -->
<!--     predicted_population <- rowMeans(predicted_pop, na.rm = T) -->
<!--     test_predictions <- test_data %>%  -->
<!--       select(Total_Pop, Total_Building_Count, Density, EA_ID) %>%  -->
<!--       cbind(predicted_density, predicted_population) -->
<!--     #rename variables in proper format -->
<!--     test_predictions <- test_predictions %>%  -->
<!--       rename(observed_population = Total_Pop, observed_density = Density) -->
<!--     #test data metrics -->
<!--     #density -->
<!--     dens_test_rmse_values[i] <- sqrt(mean((test_predictions$observed_density - test_predictions$predicted_density)^2)) -->
<!--     dens_test_pearson_values[i] <- cor(test_predictions$observed_density,  -->
<!--                                        test_predictions$predicted_density) -->
<!--     dens_test_mae_values[i] <- mean(abs(test_predictions$observed_density - test_predictions$predicted_density)) -->
<!--     dens_test_bias_values[i] <- mean(test_predictions$observed_density -  -->
<!--                                        test_predictions$predicted_density) -->
<!--     #population -->
<!--     pop_test_rmse_values[i] <- sqrt(mean((test_predictions$observed_population - test_predictions$predicted_population)^2)) -->
<!--     pop_test_pearson_values[i] <- cor(test_predictions$observed_population, test_predictions$predicted_population) -->
<!--     pop_test_mae_values[i] <- mean(abs(test_predictions$observed_population - test_predictions$predicted_population)) -->
<!--     pop_test_bias_values[i] <- mean(test_predictions$observed_population - test_predictions$predicted_population) -->
<!--     #append observed and predictions to results_df with fold information -->
<!--     fold_results <- data.frame(EA_ID = test_predictions$EA_ID,  -->
<!--                                Total_Building_Count =  -->
<!--                                  test_predictions$Total_Building_Count, -->
<!--                                folds = i, observed_density =  -->
<!--                                  test_predictions$observed_density,  -->
<!--                                predicted_density =  -->
<!--                                  test_predictions$predicted_density,  -->
<!--                                observed_population =  -->
<!--                                  test_predictions$observed_population,  -->
<!--                                predicted_population = -->
<!--                                  test_predictions$predicted_population) -->
<!--     results_df <- rbind(results_df, fold_results) -->
<!--     #train metrics -->
<!--     train_metrics <- data.frame( -->
<!--       dens_train_rmse = mean(dens_train_rmse_values), -->
<!--       dens_train_corr = mean(dens_train_pearson_values), -->
<!--       dens_train_mae = mean(dens_train_mae_values), -->
<!--       dens_train_bias = mean(dens_train_bias_values), -->
<!--       pop_train_rmse = mean(pop_train_rmse_values), -->
<!--       pop_train_corr = mean(pop_train_pearson_values), -->
<!--       pop_train_mae = mean(pop_train_mae_values), -->
<!--       pop_train_bias = mean(pop_train_bias_values) -->
<!--     ) -->
<!--     #test metrics -->
<!--     test_metrics <- data.frame( -->
<!--       dens_test_rmse = mean(dens_test_rmse_values), -->
<!--       dens_test_corr = mean(dens_test_pearson_values), -->
<!--       dens_test_mae = mean(dens_test_mae_values), -->
<!--       dens_test_bias = mean(dens_test_bias_values), -->
<!--       pop_test_rmse = mean(pop_test_rmse_values), -->
<!--       pop_test_corr = mean(pop_test_pearson_values), -->
<!--       pop_test_mae = mean(pop_test_mae_values), -->
<!--       pop_test_bias = mean(pop_test_bias_values) -->
<!--     ) -->
<!--   } -->
<!--   #return separate lists for density and population metrics -->
<!--   list(train_metrics = train_metrics, test_metrics = test_metrics,  -->
<!--        results_df = results_df) -->
<!-- } -->
<!-- ``` -->
<!-- Once the function has been created, it can be applied to the chosen dataset, in this case, the sampled Cameroon data from above. The relevant results can then be extracted and given as tables or a data frame.  -->
<!-- ```{r apply LOOCV, eval = FALSE} -->
<!-- #apply function -->
<!-- result2 <- loo_cv(data = sampled_data) -->
<!-- #Train data results -->
<!-- result2$train_metrics %>%  -->
<!--   kable() -->
<!-- #Test data results -->
<!-- result1$test_metrics %>%  -->
<!--   kable() -->
<!-- #Get results as a data frame -->
<!-- result_df <- result1$results_df -->
<!-- ``` -->
<!-- ## Check predictive ability -->
<!-- # Model fit assessment checks -->

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="bayesian-hierarchical-population-modelling-in-r.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="population-prediction-and-uncertainty-quantification.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "section",
    "scroll_highlight": true
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
